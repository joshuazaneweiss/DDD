<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ambient Drone Synth — Vv3.0</title>
<style>
  :root{
    --bg:#D1D1D1; --bg2:#C3E8EE;
    --panel:#F6F6F6; --panel2:#EFEFEF;
    --text:#0F1108; --text-strong:#0A0A0A;
    --muted:#5a5f61; --line:#D1D1D1;
    --acc:#0F1108; --acc2:#FFE900; --warn:#FB4D3D;
    --eurorack:#7F7F7F; --viz-bg:#0B0D07; --viz-grid:#2A2D22; --viz-grid-strong:#3A3F30; --viz-trim:#5b5f57; --viz-screw:#2c2f28;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0F1108; --bg2:#1a1d10; --panel:#1e2114; --panel2:#16180e;
      --text:#EDEDED; --text-strong:#FAFAFA; --muted:#d6d9db; --line:#2b2f1d;
      --acc:#FFE900; --acc2:#FFE900; --viz-grid:#24271f; --viz-grid-strong:#32372b; --viz-trim:#6a6f66; --viz-screw:#1d1f1a;
    }
  }
  *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
  body{ margin:0; color:var(--text);
    background: radial-gradient(900px 600px at 80% -10%, var(--panel2) 0%, var(--bg) 45%), linear-gradient(180deg, var(--bg), var(--bg2)); }
  header{ padding:12px; text-align:center; border-bottom:1px solid var(--line); }
  h1{ margin:0; font-size:clamp(16px, 2.5vw, 20px); letter-spacing:.2px; color:var(--text-strong); }
  .subtitle{ color:var(--muted); font-size:12px; }
  .transport{ position:sticky; bottom:env(safe-area-inset-bottom,0); z-index:20; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;
    padding:10px; background:rgba(255,255,255,.85); backdrop-filter:blur(8px); border-top:1px solid var(--line); }
  .pill{ padding:2px 8px; border-radius:999px; background:#ffffff; color:var(--acc); font-size:12px; border:1px solid var(--line); }
  .wrap{ max-width: 1400px; margin:0 auto; padding:10px; }
  main{ display:grid; gap:12px; grid-template-columns: 1fr 0.75fr; }
  @media (max-width: 900px){ main{ grid-template-columns:1fr; } }
  .card{ background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.25)), var(--panel);
    border:1px solid var(--line); border-radius:12px; padding:10px; color:var(--text-strong); }
  details.card > summary{ cursor:pointer; list-style:none; }
  details.card > summary::-webkit-details-marker{ display:none; }
  details.card > summary{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  details.card[open] > summary .chev{ transform:rotate(90deg); }
  .chev{ transition:transform .2s ease; }
  .row{ display:grid; grid-template-columns: 110px 1fr 90px; gap:8px; align-items:center; margin:6px 0; }
  .row--long{ grid-template-columns: 110px minmax(300px, 1fr) 90px; }
  .row label{ color:var(--muted); font-size:12px; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
  .gridAuto{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:8px; }
  .sep{ height:1px; background:linear-gradient(90deg, transparent, var(--line), transparent); margin:8px 0; }
  button{ background: var(--acc); color:#fff; border:1px solid rgba(0,0,0,.25); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; min-height:44px; }
  button.ghost{ background:#fff; color:var(--acc); border:1px solid var(--line); }
  button.warn{ background:#FB4D3D; color:#fff; border-color:rgba(0,0,0,.15); }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  input, select{ min-height:44px; }
  input[type="range"]{ width:100%; min-height:auto; }
  input[type="number"].num{ width:88px; padding:6px 8px; border-radius:8px; border:1px solid var(--line); }
  .seqHead, .seq{ --vissteps: 16; display:grid; grid-template-columns: 74px repeat(var(--vissteps), 1fr); gap:4px; align-items:center; }
  .stepNum{ font-size:10px; color:#7F7F7F; opacity:.7; text-align:center; }
  .label{ font-size:12px; color:var(--muted); text-align:right; padding-right:4px; }
  .cell{ border:1px solid var(--line); border-radius:7px; height: 12px; display:grid; place-items:center; user-select:none; cursor:pointer; }
  .cell.off{ background: linear-gradient(180deg, #ffffff, #f3f5f6); }
  .cell.on{  background: linear-gradient(180deg, #f8f2c6, #fff3a1); border-color:#E6D200; }
  .cell.play{ outline:2px solid var(--acc2); }
  .pager{ display:flex; gap:8px; align-items:center; }
  .meter{ font-size:12px; color:var(--muted); }

  /* Eurorack visualizer modules */
  .rack{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 768px){ .rack{ grid-template-columns:1fr; } }
  .module{ background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.08)), var(--eurorack); border:1px solid #6f6f6f; border-radius:10px; padding:10px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.25), 0 2px 6px rgba(0,0,0,.15); position:relative; }
  .module:before, .module:after{ content:""; position:absolute; top:8px; width:10px; height:10px;
    background: radial-gradient(circle at 30% 30%, #bbb, 25%, transparent 26%),
               radial-gradient(circle at 70% 70%, #333, 25%, transparent 26%),
               radial-gradient(circle at 50% 50%, var(--viz-screw), 55%, transparent 56%);
    border-radius:50%; filter: drop-shadow(0 1px 0 rgba(0,0,0,.3)); }
  .module:before{ left:10px; } .module:after { right:10px; }
  .module .labelTop{ font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:#1c1c1c; text-shadow:0 1px 0 rgba(255,255,255,.35); margin-bottom:6px; }
  .bezel{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.2)); border:1px solid var(--viz-trim); border-radius:8px; padding:6px; }
  .scope{ position:relative; border-radius:6px; overflow:hidden; background: var(--viz-bg); }
  .scope canvas{ width:100%; height:120px; display:block; }
  .scope .grid{ position:absolute; inset:0; pointer-events:none;
    background-image: linear-gradient(var(--viz-grid) 1px, transparent 1px),
                      linear-gradient(90deg, var(--viz-grid) 1px, transparent 1px),
                      linear-gradient(var(--viz-grid-strong) 2px, transparent 2px),
                      linear-gradient(90deg, var(--viz-grid-strong) 2px, transparent 2px);
    background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px; opacity:.55; }
  .controlsLine{ display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap; }
  .controlsLine label{ font-size:11px; color:var(--muted); }
  .rmsBox{ display:flex; gap:10px; align-items:center; }
  .rms{ display:inline-block; width:90px; height:10px; background:#1a1b16; border:1px solid var(--viz-trim); border-radius:6px; overflow:hidden; vertical-align:middle; }
  .rms > b{ display:block; height:100%; width:0%; background:linear-gradient(90deg, #C3E8EE, #2e7d32); }
  #err{ display:none; margin-top:6px; padding:6px 10px; background:#fff2f2; color:#722; border:1px solid #f3c4c4; border-radius:8px; font-size:12px; white-space:pre-wrap; }

  /* --- v3.0 layout additions --- */
  .layout{ display:grid; grid-template-columns: 2fr 1fr; gap:14px; }
  @media (max-width: 1000px){ .layout{ grid-template-columns: 1fr; } }
  .rightCol{ position: sticky; top: 8px; align-self:start; display:flex; flex-direction:column; gap:12px; }
  .card--scopes .scopesHeader{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-top:4px; }
  .card--scopes .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .bigRack{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 600px){ .bigRack{ grid-template-columns:1fr; } }
  .scope canvas{ height: 240px; } /* visual height; actual pixels set in JS */


  /* v3.0a: compact controls + grid spacing */
  .row{ grid-template-columns: 130px 1fr 80px; gap:12px; }
  .row--long{ grid-template-columns: 130px minmax(500px, 1fr) 80px; }
  .row label{ font-size:12px; white-space:nowrap; }
  input, select{ min-height:32px; }
  input[type="number"].num{ width:72px; padding:4px 6px; }
  input[type="range"]{ height:18px; }
  .controlsLine label{ font-size:11px; }


  /* v3.0b: overlap fixes */
  .gridAuto .row, .grid3 .row, .grid2 .row { margin: 6px 0; }
  .row input[type="range"]{ display:block; width:100%; }
  .scope{ min-height: 260px; }
  .leftCol{ min-width:0; }
  .rightCol{ min-width:0; }


  /* v3.0f: scope controls clarity */
  .card--scopes .controls label{ font-size:12px; }
  .card--scopes .controls{ margin-top:6px; }


  /* v3.0f-half-sliders: reduce slider length without changing layout */
  .row input[type="range"],
  .card--scopes .controls input[type="range"]{
    width:50%;
  }


  /* v3.0f+drag: draggable/dockable scopes */
  .card--scopes.floating{
    position: fixed;
    top: 20px; left: 20px;
    width: min(800px, 90vw);
    max-width: 95vw;
    z-index: 9999;
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
  }
  .card--scopes .scopesHeader{ cursor: default; }
  .card--scopes.floating .scopesHeader{ cursor: move; user-select: none; }


  /* v3.0f+drag2: freer dragging */
  .card--scopes.floating{ position: fixed; top: 20px; left: 20px; width: min(900px, 95vw); z-index: 9999; }
  .card--scopes.floating .scopesHeader{ cursor: move; user-select: none; touch-action: none; }


  /* v3.0f-mobileviz: stack scopes & reduce height on mobile */
  @media (max-width: 768px){
    .bigRack{ grid-template-columns: 1fr !important; }
    .scope canvas{ height: 168px !important; } /* 30% smaller vs 240px */
  }


  /* v3.0f-vertical-default: stack scopes by default; horizontal when toggled */
  .bigRack{ grid-template-columns: 1fr !important; }
  .bigRack.horizontal{ grid-template-columns: 1fr 1fr !important; }


  /* v3.0f corner-dock + small window */
  .card--scopes.dockedBR{
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: min(450px, 45vw); /* ~50% smaller */
    z-index: 9999;
  }
  .card--scopes.floating{
    position: fixed;
    top: 20px; left: 20px;
    width: min(600px, 60vw); /* still smaller than before */
    z-index: 9999;
  }
  .card--scopes.dockedBR .scope canvas,
  .card--scopes.floating .scope canvas{
    height: 120px !important; /* half of 240px */
  }


  /* v3.0f-cornerdock-small2: sizing fixes */
  .scope{ min-height: 0 !important; }            /* override earlier 260px min-height */
  .bigRack{ grid-auto-rows: auto; }               /* let rows size to content */
  .card--scopes.dockedBR, .card--scopes.floating{
    height: auto;                                 /* container follows canvases */
  }


  /* v3.0f-fitrows: keep everything inside cards */
  .card{ overflow:hidden; }
  .row{ grid-template-columns: 130px minmax(0, 1fr) 88px; }
  .row--long{ grid-template-columns: 130px minmax(0, 1fr) 88px; }
  .row input[type="range"]{ width:50%; max-width:560px; }
  input[type="number"].num{ width:88px; }


  /* v3.0f-sovereign: larger sliders + sovereign card */
  input[type="range"]{ height:34px; }
  .sovereign input[type="range"]{ width:60%; }


  /* v3.0f-wideUI: triple visual width for sliders & selects */
  .row input[type="range"],
  .card--scopes .controls input[type="range"],
  .sovereign input[type="range"]{
    width: 100%;
    max-width: 100%;
  }
  .row select,
  .sovereign select{
    width: auto;
    max-width: 100%;
  }


  /* v3.0f: fixed select widths (desktop-friendly) */
  .row select,
  .sovereign select{
    width: 360px !important;  /* tuned to fit longest labels comfortably */
    max-width: 100%;          /* prevent overflow on very narrow screens */
  }


  /* v3.0f: ensure select rows get full width so 420px fits */
  .gridAuto > .row:has(select),
  .grid2 > .row:has(select),
  .grid3 > .row:has(select){
    grid-column: 1 / -1;
  }
  /* enforce select width with higher specificity */
  .row select.select-fixed,
  .gridAuto .row select.select-fixed,
  .grid2 .row select.select-fixed,
  .grid3 .row select.select-fixed,
  .sovereign select.select-fixed{
    width: 360px !important;
    max-width: 100%;
    white-space: nowrap;
  }


  /* v3.0f VISUAL TWEAKS — no layout changes */
  /* Inputs: unify radii/padding and improve focus */
  input[type="number"].num,
  .row select,
  .sovereign select,
  input[type="text"]{
    border-radius: 8px;
    padding: 6px 10px;
    border: 1px solid var(--line);
    background: #fff;
  }
  .row select.select-fixed,
  .sovereign select.select-fixed{
    width: 360px !important;
    max-width: 100%;
    appearance: none;
    -webkit-appearance: none;
    background-image:
      linear-gradient(45deg, transparent 50%, #888 50%),
      linear-gradient(135deg, #888 50%, transparent 50%);
    background-position:
      calc(100% - 18px) 50%,
      calc(100% - 12px) 50%;
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
    padding-right: 28px;
  }
  .row select:focus,
  input:focus{
    outline: 2px solid color-mix(in srgb, var(--acc) 75%, transparent);
    outline-offset: 1px;
  }

  /* Buttons: subtle hover/active lift */
  button{
    transition: transform .06s ease, box-shadow .12s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,.08); }
  button:active{ transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,.06); }

  /* Range slider styling (WebKit/Chromium & Firefox) */
  input[type="range"]{
    -webkit-appearance:none; appearance:none;
    height: 34px; /* keep current height */
    background: transparent;
  }
  /* Track */
  input[type="range"]::-webkit-slider-runnable-track{
    height: 8px;
    background: linear-gradient(180deg, #f0f2f4, #d6dbe0);
    border: 1px solid var(--line);
    border-radius: 999px;
  }
  input[type="range"]::-moz-range-track{
    height: 8px;
    background: linear-gradient(180deg, #f0f2f4, #d6dbe0);
    border: 1px solid var(--line);
    border-radius: 999px;
  }
  /* Thumb */
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--acc);
    border: 2px solid rgba(0,0,0,.18);
    margin-top: -6px; /* center on 8px track */
    box-shadow: 0 1px 2px rgba(0,0,0,.2);
  }
  input[type="range"]::-moz-range-thumb{
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--acc);
    border: 2px solid rgba(0,0,0,.18);
    box-shadow: 0 1px 2px rgba(0,0,0,.2);
  }
  input[type="range"]:hover::-webkit-slider-thumb{ filter: brightness(1.05); }
  input[type="range"]:hover::-moz-range-thumb{ filter: brightness(1.05); }

  /* Pills: slightly softer */
  .pill{ box-shadow: inset 0 0 0 1px rgba(0,0,0,.05); }

  /* Cards: a bit more breathing room */
  .card{ padding: 12px; }
  .gridAuto, .grid2, .grid3{ gap: 10px; }


  /* Headliner titles: modular synth vibe, ~2× size */
  .headliner > summary span:first-child{
    font-family: 'Orbitron', 'Audiowide', 'Michroma', 'Rajdhani', 'Exo 2',
                 'Agency FB', 'Eurostile', 'Bank Gothic', Impact,
                 ui-sans-serif, system-ui, sans-serif;
    font-weight: 800;
    letter-spacing: .08em;
    text-transform: uppercase;
    font-size: clamp(20px, 3.2vw, 32px); /* ~2× typical card title */
    color: var(--acc);
    text-shadow:
      0 1px 0 rgba(0,0,0,.30),
      0 0 8px rgba(255,233,0,.25);
  }
  /* keep the chevron aligned with the taller title */
  .headliner > summary .chev{ transform-origin: 50% 50%; }


  /* v3.0f transport tweaks: 2× buttons + modern font + BPM at far right */
  .transport button{
    min-height: 88px;            /* ~2× the previous 44px */
    padding: 14px 18px;
    font-size: 18px;
    font-family: 'Inter', 'Poppins', 'SF Pro Display', 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
  }
  #bpmRead{
    margin-left: auto;           /* push to the right edge */
    order: 999;                  /* ensure it appears last in the flex row */
  }


  /* v3.0f: scopes size by state */
  .card--scopes.floating .scope canvas{ height: 60px !important; }   /* undocked: half size */
  .card--scopes.dockedBR .scope canvas{ height: 120px !important; }  /* docked: current size */

  /* BPM pill: larger and red */
  #bpmRead{
    margin-left: auto;
    order: 999;
    background: #FB4D3D !important;
    color: #fff !important;
    font-size: 24px;            /* ~2–3× baseline text */
    padding: 10px 18px;
    border: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,.12), inset 0 0 0 1px rgba(0,0,0,.08);
  }


/* v3.0f: center transport buttons; keep BPM at far right */
.transport{
  position: relative;      /* anchor for absolute BPM */
  justify-content: center; /* center all buttons */
}
#bpmRead{
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  margin-left: 0;
  order: initial;
}


/* Transport ghost buttons -> red with white text */
.transport button.ghost{
  background: #FB4D3D !important;
  color: #fff !important;
  border-color: rgba(0,0,0,0.15) !important;
}
.transport button.ghost:hover{ filter: brightness(1.08); }


button.warn{ background:#FB4D3D !important; color:#fff !important; border-color: rgba(0,0,0,0.15) !important; }


/* --- Sovereign Knobs --- */
.knob {
  width: 64px; height: 64px;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: 50%;
  background: radial-gradient(ellipse at 30% 30%, #ffffff 0%, #d7d7d7 40%, #b9b9b9 60%, #9a9a9a 100%);
  box-shadow: inset 0 2px 6px rgba(0,0,0,.25), 0 2px 4px rgba(0,0,0,.15);
  position: relative; user-select: none; touch-action: none;
  margin-left: 12px;
}
.knob-face {
  width: 58px; height: 58px; border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #f5f5f5, #cfcfcf);
  display: flex; align-items: center; justify-content: center;
  transform: rotate(0deg);
  transition: transform 0.03s linear;
}
.knob-tick { width: 3px; height: 16px; border-radius: 2px; background: #0F1108; transform: translateY(-18px); }
.input-hidden-for-knob {
  position: absolute !important; width: 1px !important; height: 1px !important;
  padding: 0 !important; margin: -1px !important; overflow: hidden !important;
  clip: rect(0 0 0 0) !important; white-space: nowrap !important; border: 0 !important;
}
.row.row--long, .row { flex-wrap: wrap; gap: 8px 12px; }


/* --- Knob enhancements: wrapper, readout, marks --- */
.knob-wrap {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin-left: 6px;
}
.knob-readout {
  width: 64px;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 8px;
  border: 1px solid var(--line, #D1D1D1);
  background: #FFFFFF;
  color: var(--text, #0F1108);
}
.knob-face { position: relative; }
.knob-mark {
  position: absolute;
  top: 50%; left: 50%;
  width: 2px;
  background: rgba(15,17,8,0.6);
  transform-origin: center;
  border-radius: 1px;
}
.knob-mark--minor { height: 6px; opacity: 0.5; }
.knob-mark--major { height: 10px; opacity: 0.85; }


/* --- Sovereign text color overrides (dark on light) --- */
.sovereign-row label,
.sovereign-row .knob-readout,
.sovereign-row input[type="number"] {
  color: #111 !important;
}
/* Ensure number input contrasts well */
.knob-readout {
  background: #FFFFFF !important;
  color: #111 !important;
  border-color: rgba(0,0,0,0.25) !important;
}


/* --- Ridged/knurled knob aesthetic --- */
.knob {
  width: 68px; height: 68px;
  position: relative;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: 50%;
  background: none; box-shadow: none;
}
.knob-rim {
  position: absolute; inset: 0;
  border-radius: 50%;
  /* Knurling via repeating-conic-gradient */
  background:
    radial-gradient(closest-side, rgba(0,0,0,0) 74%, rgba(0,0,0,0.25) 75%, rgba(0,0,0,0) 76%) ,
    repeating-conic-gradient(from 0deg, #e8e8e8 0 6deg, #bebebe 6deg 12deg);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.5);
}
.knob-face {
  position: relative;
  width: 56px; height: 56px;
  border-radius: 50%;
  /* subtle circular lines + shading */
  background:
    radial-gradient(circle at 30% 30%, #f6f6f6 0%, #d8d8d8 60%, #c0c0c0 100%),
    repeating-conic-gradient(from 0deg, rgba(0,0,0,0.04) 0 3deg, rgba(0,0,0,0) 3deg 6deg);
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.25);
}
.knob-cap {
  position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
  width: 16px; height: 16px; border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #eeeeee, #cfcfcf);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.25), 0 1px 1px rgba(255,255,255,0.6);
}
.knob-tick {
  width: 3px; height: 16px; border-radius: 2px;
  background: #111;
  transform: translateY(-18px);
  box-shadow: 0 0 1px rgba(0,0,0,0.25);
}
/* Dial marks slightly darker for visibility */
.knob-mark { background: rgba(17,17,17,0.7); }
.knob-mark--minor { height: 6px; opacity: 0.55; }
.knob-mark--major { height: 10px; opacity: 0.9; }


/* --- Illustrated (B/W stipple) knob style --- */
.knob { width: 72px; height: 72px; }
.knob-face {
  width: 62px; height: 62px;
  border-radius: 50%;
  background: #fff; /* paper white */
  box-shadow: inset 0 0 0 2px #111; /* ink outline */
  position: relative;
}
/* Stipple ink layer (dot field) */
.knob-ink {
  position: absolute; inset: 6px; /* inner margin so the ink doesn't touch the outline */
  border-radius: 50%;
  background-image:
    radial-gradient(#111 1px, transparent 1.1px); /* dots */
  background-size: 5px 5px;
  background-position: 0 0;
  /* Fade the dots from heavy shadow (bottom-right) to light (top-left) */
  -webkit-mask-image: radial-gradient(circle at 65% 65%, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.75) 40%, rgba(0,0,0,0.35) 70%, rgba(0,0,0,0.05) 100%);
          mask-image: radial-gradient(circle at 65% 65%, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.75) 40%, rgba(0,0,0,0.35) 70%, rgba(0,0,0,0.05) 100%);
}
/* Outer ring to suggest bezel */
.knob-ring {
  position: absolute; inset: -4px;
  border-radius: 50%;
  border: 2px solid #111;
}
/* Pointer layer rotates; face stays static so the stipple doesn't spin */
.knob-pointer {
  position: absolute; inset: 0;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  transform: rotate(0deg);
  transition: transform 0.03s linear;
}
.knob-tick {
  width: 3px; height: 18px; border-radius: 1px;
  background: #111;
  transform: translateY(-20px);
  box-shadow: none;
}
/* Dial marks: simple ink lines */
.knob-mark { background: #111; opacity: 0.8; }
.knob-mark--minor { height: 6px; }
.knob-mark--major { height: 10px; }
/* Sovereign text & readouts in charcoal */
.sovereign-row label,
.sovereign-row .knob-readout { color: #111 !important; }
.knob-readout {
  background: #fff !important; color: #111 !important;
  border: 1px solid #111 !important; border-radius: 6px;
}


/* --- Attach numeric readout tightly to knob --- */
.knob-wrap {
  position: relative;
  display: inline-block;
  vertical-align: middle;
}
.knob-readout {
  position: absolute;
  top: 50%;
  left: calc(100% - 6px); /* slight overlap so it feels attached */
  transform: translateY(-50%);
  width: 84px;
  padding: 3px 6px;
  font-size: 12px;
  line-height: 18px;
  border-radius: 6px;
  box-shadow: 0 1px 0 rgba(0,0,0,0.05);
}
/* Reduce gaps in the sovereign rows that contain knobs */
.sovereign-row { display: flex; align-items: center; gap: 6px; }
.sovereign-row label { margin-right: 6px; }


/* --- Enlarge BPM sliders 5x --- */
#tempoTop, #tempo {
  transform-origin: left center;
  transform: scale(2.5); /* 2.5x width & height ~= 6.25x area; strong visual boost */
}
/* Keep surrounding row from overflowing awkwardly */
#tempoTop, #tempo { margin: 6px 0; }


/* --- BPM slider: longer track (no scaling) --- */
#tempoTop, #tempo {
  transform: none !important;
  width: clamp(520px, 62vw, 980px) !important; /* wide, responsive */
}
/* Keep layout tidy */
#tempoTop, #tempo { margin: 6px 0 8px 0; }


/* --- Super‑long BPM slider (~4× previous) --- */
#tempoTop, #tempo {
  width: 2400px !important;  /* very long track */
  max-width: none !important;
  transform: none !important;
}
.wide-slider-row { overflow-x: auto; }


/* Allow overflow for the Sovereign card so extra-long controls are visible */
details.card.sovereign {
  overflow: visible !important;
}
/* Also ensure the inner container doesn't clip */
details.card.sovereign > .gridAuto {
  overflow: visible !important;
}
/* Keep the wide row scrollable as needed */
details.card.sovereign .wide-slider-row {
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch;
}


/* --- BPM slider compact: 240px width --- */
#tempoTop, #tempo {
  width: 240px !important;
  max-width: 240px !important;
  transform: none !important;
}


/* --- Unified toggle label style (grey, +25%) --- */
details .gridAuto .row > label,
.row > label {
  color: var(--muted, #5a5f61) !important;
  font-size: 125% !important;
}


/* --- BPM slider compact: 180px --- */
#tempoTop, #tempo { width: 180px !important; max-width: 180px !important; transform:none !important; }

/* --- Toggle labels: ~10% smaller than previous --- */
details .gridAuto .row > label,
.row > label { font-size: 112.5% !important; }

/* --- BPM slider compact: 160px --- */
#tempoTop, #tempo { width: 160px !important; max-width: 160px !important; transform:none !important; }

/* --- Module spacing: 8x buffer between header and each module --- */
:root{ --module-gap: 32px; } /* tuneable; ~8x baseline spacing */
.transport { margin-bottom: var(--module-gap) !important; }
details.card { margin-top: var(--module-gap) !important; margin-bottom: var(--module-gap) !important; }


/* --- Normalize module titles (ensure MIDI matches others) --- */
details.card > summary > span:first-child {
  font-family: inherit !important;
  color: var(--text, #0F1108) !important;
  font-size: 1.25rem !important; /* matches typical headliner sizing */
  font-weight: 700 !important;
  letter-spacing: 0.01em;
}
/* If MIDI uses a different tag (e.g., h3), normalize it too */
summary h3, summary h4, summary .midi-title {
  font-family: inherit !important;
  color: var(--text, #0F1108) !important;
  font-size: 1.25rem !important;
  font-weight: 700 !important;
  margin: 0;
}


/* --- Module titles: revert to yellow theme and match across sections (incl. MIDI) --- */
details.card > summary > span:first-child {
  color: var(--acc2, #FFE900) !important; /* yellow accent */
  font-family: inherit !important;        /* follow app font */
  /* keep existing size/weight unless theme sets differently */
}


/* --- Drums: step buttons text color -> blue to match check --- */
details.card.drums button, details.card.drums .row button {
  color: #0275FF !important;
}


/* --- Drums tweaks --- */
details.card.drums .pager .ghost { color: #0275FF !important; }
details.card.drums .stepNum { color: #0275FF !important; opacity: 1 !important; font-weight: 600; }
details.card.drums .seq-page-label { color: var(--text, #0F1108); font-size: 12px; }


/* --- Drums pager buttons: blue pill, white text, single line --- */
details.card.drums .pager { flex-wrap: nowrap !important; gap: 10px; }
details.card.drums .pager .ghost {
  background: #0275FF !important;
  color: #FFFFFF !important;
  border-color: rgba(0,0,0,0.2) !important;
  white-space: nowrap !important;
  padding: 8px 14px !important;
  height: auto !important;
  line-height: 1.1 !important;
  border-radius: 9999px !important;
  font-weight: 600;
  box-shadow: 0 1px 2px rgba(0,0,0,0.12);
}


/* --- Sequence page label styled like headlines (yellow), at ~80% size --- */
details.card.drums .seq-page-label {
  color: var(--acc2, #FFE900) !important;   /* same yellow as headlines */
  font-family: inherit !important;          /* same font */
  font-size: 1rem !important;               /* ~80% of typical 1.25rem headline */
  font-weight: inherit;                     /* track app's default weight */
  letter-spacing: 0.01em;
}


/* --- Force '16 SEQUENCE / 9–16' label to match yellow headlines at ~80% size --- */
details.card.drums #pageLabel {
  color: var(--acc2, #FFE900) !important;   /* yellow accent */
  font-family: inherit !important;
  font-size: 1rem !important;               /* ~80% of 1.25rem headline */
  font-weight: 700 !important;
  letter-spacing: 0.01em;
}


/* --- Drums: step number headers = headline yellow --- */
details.card.drums .stepNum {
  color: var(--acc2, #FFE900) !important;
  opacity: 1 !important;
  font-weight: 700;
}



/* ===== DRUMS: slider width fixes ===== */
details.card.drums .grid3 {
  grid-template-columns: 1fr !important; /* give each row full width */
}
details.card.drums .row,
details.card.drums .row.row--long {
  grid-template-columns: 130px minmax(520px, 1fr) 88px !important;
  gap: 12px !important;
}
/* Ensure all drum sliders stretch fully */
details.card.drums input[type="range"] {
  width: 50% !important;
  max-width: none !important;
}
/* Undo compact BPM override inside Drums so the tempo slider can be full width */
details.card.drums #tempo {
  width: 50% !important;
  max-width: none !important;
}
/* Make numeric inputs consistent */
details.card.drums input[type="number"].num {
  width: 88px !important;
}
/* ===== end DRUMS fixes ===== */


/* ===== DRUMS: numeric inputs ~15px from sliders ===== */
details.card.drums .row,
details.card.drums .row.row--long {
  column-gap: 15px !important; /* slider <-> number gap */
}
/* Right-align sliders so their right edge sits next to the number field */
details.card.drums input[type="range"] {
  margin-left: auto !important;
  display: block !important;
}
/* Ensure tempo slider follows same alignment */
details.card.drums #tempo {
  margin-left: auto !important;
  display: block !important;
}
/* ===== end ===== */


/* ===== DRUMS: make whole module ~200px narrower ===== */
details.card.drums {
  width: calc(100% - 200px) !important; /* shrink overall footprint */
  box-sizing: border-box !important;
  justify-self: start !important; /* if parent is a grid, align to the left of its cell */
}
/* Keep it full-width on narrow screens */
@media (max-width: 900px) {
  details.card.drums {
    width: 100% !important;
  }
}
/* ===== end ===== */


/* ===== DRUMS: responsive internals while keeping narrower width ===== */
/* Keep the ~200px narrower footprint but let internals flex */
details.card.drums {
  width: calc(100% - 200px) !important;
  box-sizing: border-box !important;
  justify-self: start !important;
}
@media (max-width: 900px) {
  details.card.drums { width: 100% !important; }
}

/* Responsive 3-col grid: label | slider | number */
details.card.drums .row,
details.card.drums .row.row--long {
  display: grid !important;
  grid-template-columns:
    clamp(110px, 18%, 140px)
    minmax(260px, 1fr)
    clamp(70px, 12%, 96px) !important;
  column-gap: 15px !important; /* slider <-> number gap */
  align-items: center !important;
}

/* Sliders fill their column; no hard pixel widths */
details.card.drums input[type="range"],
details.card.drums #tempo {
  width: 100% !important;
  max-width: none !important;
  margin-left: 0 !important;
  display: block !important;
}

/* Numeric inputs size responsively but stay compact */
details.card.drums input[type="number"].num {
  width: clamp(70px, 12%, 96px) !important;
}

/* Dropdown stretches nicely within its row */
details.card.drums select {
  width: 100% !important;
  max-width: 100% !important;
}

/* Keep "Steps" button pair from squishing */
details.card.drums .steps-controls,
details.card.drums .steps-controls .btn {
  flex-wrap: nowrap !important;
  white-space: nowrap !important;
}
/* ===== end ===== */


/* ===== SOVEREIGN: BPM cosmetic tweaks ===== */
details.card.sovereign label[for="tempoTop"] {
  color: var(--acc) !important; /* use the headline yellow */
}
details.card.sovereign #tempoTop {
  width: calc(100% - 15px) !important; /* 15px shorter track */
  max-width: calc(100% - 15px) !important;
}
/* ===== end ===== */


/* ===== SOVEREIGN: keep BPM slider large on wide windows ===== */
/* Make the BPM row span the whole card even when gridAuto makes multiple columns */
details.card.sovereign .gridAuto > .row:has(#tempoTop) {
  grid-column: 1 / -1 !important;
}

/* Give that BPM row a generous template so the slider stays long */
details.card.sovereign .row:has(#tempoTop) {
  grid-template-columns: 130px minmax(520px, 1fr) 88px !important;
  column-gap: 15px !important;
}

/* Keep the 15px-shorter track but allow a healthy max width on big screens */
details.card.sovereign #tempoTop {
  width: min(calc(100% - 15px), 980px) !important;
  max-width: none !important;
}
/* ===== end ===== */


/* ===== SOVEREIGN: BPM slider at half current width, centered ===== */
details.card.sovereign #tempoTop {
  width: min(calc((100% - 15px)/2), 490px) !important; /* half of previous min(...) */
  max-width: none !important;
  margin: 0 auto !important; /* center within the slider column */
  display: block !important;
}
/* ===== end ===== */


/* ===== DRUMS: remove the Steps row UI (keep page label) ===== */
/* Hide the 'Steps' label and the pager buttons */
details.card.drums .row:has(.pager) > label { display: none !important; }
details.card.drums .row .pager { display: none !important; }

/* Collapse that row layout so the page label sits naturally */
details.card.drums .row:has(.pager) {
  grid-template-columns: 1fr !important;
  column-gap: 0 !important;
  padding-top: 0 !important;
}

/* Make the page label align left and look intentional */
details.card.drums #pageLabel {
  justify-self: start !important;
  margin: 0 0 6px 0 !important;
}
/* ===== end ===== */


/* v3.0a: nudge scope module titles right 5px */
.card--scopes .module .labelTop{
  margin-left: 5px !important;
}


/* v3.0e: Scopes — clean stacked layout + hide 'Vertical layout' control */
.card--scopes .bigRack{ grid-template-columns: 1fr !important; row-gap: 12px !important; }
.card--scopes .module .labelTop{ text-align:center !important; margin:0 0 6px 0 !important; }
.card--scopes .scope canvas{ height: 240px !important; }
@media (max-width: 768px){ .card--scopes .scope canvas{ height: 168px !important; } }
.card--scopes .bezel{ padding: 8px !important; margin: 0 !important; }
.card--scopes .controlsLine{ margin-top: 8px !important; }
/* Hide "Vertical layout" checkbox+label if present */
.card--scopes .scopesHeader label.meter:has(input[type="checkbox"]):has(+ *):contains("Vertical layout"){ display:none !important; }
/* Fallback: hide by input id if exists */
#vertLayout, #vertStack { display:none !important; }
label[for="vertLayout"], label[for="vertStack"] { display:none !important; }
/* Keep header controls tidy */
.card--scopes .scopesHeader{ display:flex; align-items:center; gap:10px !important; flex-wrap:wrap; }
.card--scopes .scopesHeader .controls{ display:flex; align-items:center; gap:10px !important; flex-wrap:wrap; }


/* v3.0f: remove 'Scopes' label and 'Undock' button from scopes header */
.card--scopes .scopesHeader strong{ display:none !important; }
.card--scopes .scopesHeader button{ display:none !important; } /* Undock */


/* v3.0g: scope controls spacing */
.card--scopes .scopesHeader .controls label.meter{ display:inline-flex; gap:6px; align-items:center; }


/* === v3.0j: Cohesive Transport Toolbar === */
.transport--cohesive{
  background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.25)), var(--panel);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 14px;
  gap: 10px;
  justify-content: center;
}
.transport--cohesive .btn, .transport--cohesive .pill{
  height: 56px;
  padding: 0 18px;
  border-radius: 14px;
  font-weight: 700;
  letter-spacing: .2px;
  border: 1px solid var(--line);
  box-shadow: 0 2px 0 rgba(0,0,0,.08);
  transition: transform .04s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease, border-color .12s ease;
}
.transport--cohesive .btn:active{ transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,.08); }

/* Base */
.btn{ background: #fff; color: var(--text); }
/* Primary (Start) — school accent yellow */
.btn--primary{
  background: var(--acc2); color: #111; border-color: rgba(0,0,0,.15);
}
.btn--primary:hover{ filter: brightness(1.04); }
/* Danger (Panic) */
.btn--danger{
  background: var(--warn); color:#fff; border-color: rgba(0,0,0,.15);
}
.btn--danger:hover{ filter: brightness(1.03); }
/* Ghost/utility (Tap, Rebuild, Save, Load) */
.btn--ghost{
  background: #FAFAFA; color:#111; border-color: var(--line);
}
.btn--ghost:hover{ background:#F2F2F2; }
/* Muted (Stop) */
.btn--muted{
  background: #EFEFEF; color:#444; border-color: var(--line);
}
.btn--muted:hover{ background:#E8E8E8; }
/* Outline danger (Reset) */
.btn--outline-danger{
  background: transparent; color: var(--warn); border-color: var(--warn);
}
.btn--outline-danger:hover{ background: rgba(251,77,61,0.08); }

/* BPM pill aligned with system */
.pill--accent{
  display:inline-flex; align-items:center; justify-content:center;
  background: #FFFFFF;
  color: #111;
  border: 2px solid var(--acc2);
  border-radius: 999px;
  padding: 0 16px;
  font-weight: 800;
}

/* Tighten toolbar on small screens */
@media (max-width: 900px){
  .transport--cohesive .btn, .transport--cohesive .pill{ height: 48px; padding: 0 14px; }
  .transport--cohesive{ gap: 8px; }
}


/* v3.0m: Sequencer analog glow + persistence */
.seqHead, .seq{
  position: relative;
  background: var(--viz-bg);
  border: 1px solid var(--viz-trim);
  border-radius: 8px;
  padding: 6px;
  overflow: hidden;
}
.seqHead::before, .seq::before{
  content: ""; position: absolute; inset: 0; pointer-events: none;
  background-image: linear-gradient(var(--viz-grid) 1px, transparent 1px),
                    linear-gradient(90deg, var(--viz-grid) 1px, transparent 1px),
                    linear-gradient(var(--viz-grid-strong) 2px, transparent 2px),
                    linear-gradient(90deg, var(--viz-grid-strong) 2px, transparent 2px);
  background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
  opacity: .35;
}

/* Cells: subtle bezel + yellow-lit states to match scopes */
:root{ --seq-lit: var(--acc2); }
.seq .label, .seqHead > div:first-child{ color: var(--muted); }
.cell{
  border: 1px solid var(--viz-trim);
  border-radius: 6px;
  height: 14px;
  background: linear-gradient(180deg, #ffffff, #f3f5f6);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.3);
  transition: box-shadow .15s ease, background-color .15s ease, border-color .15s ease, transform .04s ease;
}
.cell.on{
  background: color-mix(in srgb, var(--seq-lit) 40%, #fff);
  border-color: color-mix(in srgb, var(--seq-lit) 75%, #E6D200);
  box-shadow:
    0 0 0 1px color-mix(in srgb, var(--seq-lit) 40%, transparent) inset,
    0 0 6px color-mix(in srgb, var(--seq-lit) 55%, transparent),
    0 0 18px color-mix(in srgb, var(--seq-lit) 35%, transparent);
}
/* current playhead step: stronger glow + slight lift */
.cell.play{
  box-shadow:
    0 0 0 1px color-mix(in srgb, var(--seq-lit) 55%, transparent) inset,
    0 0 10px color-mix(in srgb, var(--seq-lit) 70%, transparent),
    0 0 26px color-mix(in srgb, var(--seq-lit) 50%, transparent);
  transform: translateY(-0.5px);
}

/* Afterglow trails (added by JS for previous steps), fade out via animation */
@keyframes afterglow1 { from { box-shadow: 0 0 8px color-mix(in srgb, var(--seq-lit) 60%, transparent); } to { box-shadow: 0 0 0 rgba(0,0,0,0); } }
@keyframes afterglow2 { from { box-shadow: 0 0 5px color-mix(in srgb, var(--seq-lit) 45%, transparent); } to { box-shadow: 0 0 0 rgba(0,0,0,0); } }
.cell.trail1{ animation: afterglow1 .28s ease-out forwards; }
.cell.trail2{ animation: afterglow2 .45s ease-out forwards; }

/* Step numbers: use yellow to echo headlines but dimmer */
.stepNum{ color: color-mix(in srgb, var(--acc2) 70%, #888); text-shadow: 0 1px 0 rgba(0,0,0,.2); }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Ambient Drone Synth — v3.0</h1>
      <div class="subtitle">Save/Load settings • Numeric inputs • Audio hotfix • Eurorack scopes</div>
      <div id="err"></div>
    </header>

    <div class="transport transport--cohesive">
      <button id="startBtn" class="btn btn--primary">Start</button>
      <button id="stopBtn" class="btn btn--muted" disabled>Stop</button>
      <button id="panicBtn" class="btn btn--danger" title="Silence & reset envelopes">Panic</button>
      <button id="tapBtn" class="btn btn--ghost" title="Tap tempo (4+ taps)">Tap</button>
      <span id="bpmRead" class="pill pill--accent">60 BPM</span>
      <button id="rebuildBtn" class="btn btn--ghost" title="Recreate audio graph">Rebuild</button>
      <button id="saveBtn" class="btn btn--ghost" title="Save settings locally">Save</button>
      <button id="loadBtn" class="btn btn--ghost" title="Load saved settings">Load</button>
      <button id="resetBtn" class="btn btn--outline-danger" title="Reset to defaults">Reset</button>
      
      
      
      
    </div>

    
<main class="layout">
  <div class="leftCol">

      <!-- SOVEREIGN -->
      <details class="card sovereign headliner" open>
        <summary><span>sovereign</span><span class="chev">▶</span></summary>
        <div class="gridAuto">
          <div class="row row--long"><label>Total Volume</label>
            <input id="globalVol" type="range" min="0" max="1" step="0.001" value="0.534">
            <span></span>
          </div>
          <div class="row row--long"><label>Distortion</label>
            <input id="globalDrive" type="range" min="0" max="1" step="0.001" value="0.013">
            <span></span>
          </div>
          <div class="row row--long"><label>Reverb Wet</label>
            <input id="revWetTop" type="range" min="0" max="1" step="0.001" value="0.348">
            <span></span>
          </div>
          <div class="row row--long"><label for="tempoTop">BPM</label>
            <input id="tempoTop" type="range" min="5" max="300" step="1" value="60">
            <span></span>
          </div>
        </div>
      </details>


      <!-- DRONE -->
      <details class="card headliner" open>
        <summary><span>Drone</span><span class="chev">▶</span></summary>
        <div class="gridAuto">
          <div class="row"><label>Preset</label><select id="presetSelect" class="select-fixed"></select><span></span></div>
          <div class="row"><label>Waveform</label>
            <select id="wave" class="select-fixed"><option>sine</option><option>triangle</option><option>square</option><option selected>sawtooth</option></select><span></span>
          </div>
          <div class="row"><label>Key (note)</label><select id="noteRoot" class="select-fixed"></select><span></span></div>
          <div class="row"><label>Octave</label><input id="octave" type="number" min="0" max="8" step="1" value="2" class="num"><span></span></div>

          <div class="row row--long"><label>Detune (¢)</label>
            <input id="detune" type="range" min="0" max="50" step="1" value="12">
            <input id="detuneNum" type="number" min="0" max="50" step="1" value="12" class="num">
          </div>
          <div class="row row--long"><label>Stereo Width</label>
            <input id="spread" type="range" min="0" max="1" step="0.01" value="0.8">
            <input id="spreadNum" type="number" min="0" max="1" step="0.01" value="0.8" class="num">
          </div>
          <div class="row row--long"><label>Volume</label>
            <input id="master" type="range" min="0" max="1" step="0.001" value="0.3">
            <input id="masterNum" type="number" min="0" max="1" step="0.001" value="0.3" class="num">
          </div>
          <div class="row row--long"><label>Pan</label>
            <input id="dronePan" type="range" min="-1" max="1" step="0.01" value="-0.2">
            <input id="dronePanNum" type="number" min="-1" max="1" step="0.01" value="-0.2" class="num">
          </div>
          <div class="row"><label>Hold Drone</label><input id="holdToggle" type="checkbox" checked><span></span></div>
        </div>
        <div class="sep"></div>
        <div class="gridAuto">
          <div class="row"><label>Filter Type</label>
            <select id="filterType" class="select-fixed"><option value="lowpass" selected>Low‑pass</option><option value="bandpass">Band‑pass</option><option value="highpass">High‑pass</option></select><span></span>
          </div>
          <div class="row row--long"><label>Cutoff (Hz)</label>
            <input id="cutoff" type="range" min="20" max="12000" step="1" value="900">
            <input id="cutoffNum" type="number" min="20" max="12000" step="1" value="900" class="num">
          </div>
          <div class="row row--long"><label>Resonance (Q)</label>
            <input id="resonance" type="range" min="0.1" max="25" step="0.1" value="0.9">
            <input id="resonanceNum" type="number" min="0.1" max="25" step="0.1" value="0.9" class="num">
          </div>
          <div class="row"><label>LFO Target</label>
            <select id="lfoTarget" class="select-fixed"><option value="filter" selected>Filter</option><option value="amp">Amplitude</option><option value="pitch">Pitch</option></select><span></span>
          </div>
          <div class="row row--long"><label>LFO Rate (Hz)</label>
            <input id="lfoRate" type="range" min="0.005" max="10" step="0.001" value="0.07">
            <input id="lfoRateNum" type="number" min="0.005" max="10" step="0.001" value="0.07" class="num">
          </div>
          <div class="row row--long"><label>LFO Depth</label>
            <input id="lfoDepth" type="range" min="0" max="1" step="0.001" value="0.5">
            <input id="lfoDepthNum" type="number" min="0" max="1" step="0.001" value="0.5" class="num">
          </div>
          <div class="row row--long"><label>Distortion</label>
            <input id="distAmt" type="range" min="0" max="1" step="0.001" value="0.08">
            <input id="distAmtNum" type="number" min="0" max="1" step="0.001" value="0.08" class="num">
          </div>
          <div class="row row--long"><label>Reverb Decay (s)</label>
            <input id="revDecay" type="range" min="0.5" max="45" step="0.1" value="14">
            <input id="revDecayNum" type="number" min="0.5" max="45" step="0.1" value="14" class="num">
          </div>
          <div class="row row--long"><label>Reverb Size</label>
            <input id="revSize" type="range" min="0.1" max="1" step="0.01" value="0.95">
            <input id="revSizeNum" type="number" min="0.1" max="1" step="0.01" value="0.95" class="num">
          </div>
          <div class="row row--long"><label>Reverb Wet</label>
            <input id="revWet" type="range" min="0" max="1" step="0.001" value="0.55">
            <input id="revWetNum" type="number" min="0" max="1" step="0.001" value="0.55" class="num">
          </div>
        </div>

        </details>

      <!-- DRUMS -->
      <details class="card headliner" open>
        <summary><span>Drums</span><span class="chev">▶</span></summary>
        <div class="grid3">
          <div class="row row--long"><label>Tempo (BPM)</label>
            <input id="tempo" type="range" min="5" max="300" step="1" value="60">
            <input id="tempoNum" class="num" type="number" min="5" max="300" step="1" value="60" />
          </div>
          <div class="row row--long"><label>Swing %</label>
            <input id="swing" type="range" min="0" max="100" step="1" value="12">
            <input id="swingNum" type="number" min="0" max="100" step="1" value="12" class="num">
          </div>
          <div class="row"><label>Drum Preset</label><select id="drumPreset" class="select-fixed"></select><span></span></div>
        </div>
        <div class="grid3">
          <div class="row"><label>Steps</label>
            <div class="pager">
              <button id="pagePrev" class="ghost">◀ 1–16</button>
              <button id="pageNext" class="ghost">1–16 ▶</button>
            </div>
            <span class="meter" id="pageLabel">16 SEQUENCE</span>
          </div>
          <div class="row row--long"><label>Pan</label>
            <input id="drumPan" type="range" min="-1" max="1" step="0.01" value="0.25">
            <input id="drumPanNum" type="number" min="-1" max="1" step="0.01" value="0.25" class="num">
          </div>
          <div class="row row--long"><label>Volume</label>
            <input id="drumVol" type="range" min="0" max="1" step="0.001" value="0.9">
            <input id="drumVolNum" type="number" min="0" max="1" step="0.001" value="0.9" class="num">
          </div>
        </div>
        <div class="grid3">
          <div class="row row--long"><label>HPF (Hz)</label>
            <input id="drumHPF" type="range" min="20" max="2000" step="1" value="50">
            <input id="drumHPFNum" type="number" min="20" max="2000" step="1" value="50" class="num">
          </div>
          <div class="row row--long"><label>LPF (Hz)</label>
            <input id="drumLPF" type="range" min="1000" max="20000" step="1" value="16000">
            <input id="drumLPFNum" type="number" min="1000" max="20000" step="1" value="16000" class="num">
          </div>
          <div class="row row--long"><label>Drive</label>
            <input id="drumDrive" type="range" min="0" max="1" step="0.001" value="0.15">
            <input id="drumDriveNum" type="number" min="0" max="1" step="0.001" value="0.15" class="num">
          </div>
          <div class="row"><label>Compressor</label><input id="drumComp" type="checkbox" checked><span></span></div>
          <div class="row row--long"><label>Reverb Send</label>
            <input id="drumRevSend" type="range" min="0" max="1" step="0.001" value="0.3">
            <input id="drumRevSendNum" type="number" min="0" max="1" step="0.001" value="0.3" class="num">
          </div>
        </div>

        <div class="sep"></div>
        <div id="seqHead" class="seqHead"></div>
        <div id="seqAccent" class="seq"></div>
        <div id="seqKick" class="seq"></div>
        <div id="seqSnare" class="seq"></div>
        <div id="seqHat" class="seq"></div>

        <div class="buttons" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;margin-top:10px;">
          <button id="randSparseBtn" class="ghost">Random (Sparse)</button>
          <button id="randGrooveBtn" class="ghost">Random (Groove)</button>
          <button id="randDenseBtn" class="ghost">Random (Dense)</button>
          <button id="clearBtn" class="ghost">Clear</button>
        </div>
      </details>

      <!-- MIDI -->
      <details class="card">
        <summary><span>MIDI</span><span class="chev">▶</span></summary>
        <div class="grid2">
          <div class="row"><label>Input</label><select id="midiIn" class="select-fixed"></select><span id="midiStatus" class="meter">MIDI: initializing…</span></div>
          <div class="row"><label>Note Mode</label><select id="noteMode" class="select-fixed"><option value="last" selected>Last Note</option><option value="low">Lowest Held</option><option value="high">Highest Held</option></select><span></span></div>
        </div>
      </details>
    
  </div>
  <aside class="rightCol">
    <div class="card card--scopes">
      <div class="scopesHeader"><label class="meter" style="margin-left:auto;"><input type="checkbox" id="vizVertical" checked/> Vertical layout</label><button id="dockToggle" class="ghost" style="margin-left:auto;">Undock</button>
        <strong>Scopes</strong>
        <div class="controls"><label class="meter"><input type="checkbox" id="trigOn" checked/> Trigger</label><label class="meter">Window <select id="timeWindow"><option value="0.25">250 ms</option><option value="0.5" selected>500 ms</option><option value="1">1 s</option><option value="2">2 s</option></select></label><label class="meter">Y‑Zoom <input id="yZoom" type="range" min="0.5" max="4" step="0.1" value="2" style="width:120px;vertical-align:middle;"></label>
          <label class="meter"><input type="checkbox" id="gridOn" checked/> Grid</label>
          <label class="meter"><input type="checkbox" id="persistOn" checked/> Persistence</label>
          <label class="meter">Glow <input id="glow" type="range" min="0" max="20" step="1" value="8" style="width:140px;vertical-align:middle;"></label>
        </div>
      </div>
      <div class="bigRack" style="margin-top:8px;">
        <div class="module">
          <div class="labelTop">Drone Scope</div>
          <div class="bezel">
            <div class="scope"><canvas id="vizDrone"></canvas><div class="grid" id="gridDrone"></div></div>
            <div class="controlsLine"><span class="meter">RMS</span><span class="rms"><b id="rmsD"></b></span></div>
          </div>
        </div>
        <div class="module">
          <div class="labelTop">Drums Scope</div>
          <div class="bezel">
            <div class="scope"><canvas id="vizDrum"></canvas><div class="grid" id="gridDrum"></div></div>
            <div class="controlsLine"><span class="meter">RMS</span><span class="rms"><b id="rmsB"></b></span></div>
          </div>
        </div>
      </div>
    </div>
  </aside>
</main>

  </div>

<script>
(() => {
  window.addEventListener('error', function(e){ var box=document.getElementById('err'); box.style.display='block'; box.textContent='Error: '+e.message; });

  var NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  function noteToFreq(noteNumber){ return 440 * Math.pow(2, (noteNumber - 69) / 12); }
  function nameOctToMidi(name, oct){ return NOTE_NAMES.indexOf(name) + (oct + 1) * 12; }
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  function $(id){ return document.getElementById(id); }

  const STORE_KEY = 'drone_v2_7_0_state';

  var ctx, started=false, running=false;
  var leftMix, rightMix, channelMerger;
  var globalShaper, globalMaster;
  var osc1, osc2, ampVCA, filter, waveShaper, dronePan, droneMaster, convolver, revWet, revDry, lfoOsc, lfoGain;
  var drumHPF, drumLPF, drumShaper, drumComp, drumPanNode, drumMaster, drumSend, drumDry;
  var anaDrone, anaDrum, vizRAF=null, scopesEnabled=true; var ringDrone=null, ringPos=0;

  var steps=16, page=0;
  var seq = makeEmptySeq(steps);
  var currentStep=0, tempo=60, swingPct=12;
  var nextNoteTime=0, isSequencing=false, schedulerTimer=null;

  function makeEmptySeq(n){ function mk(){ return Array.from({length:n}, () => false ); } return { accent: mk(), kick: mk(), snare: mk(), hat: mk() }; }
  function safeStereoPanner(){ try { return ctx.createStereoPanner(); } catch(e){ var g=ctx.createGain(); g.pan = { value:0, setTargetAtTime:function(){} }; return g; } }

  function createAudio(){
    ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'playback'});
    leftMix = ctx.createGain(); rightMix = ctx.createGain();
    channelMerger = ctx.createChannelMerger(2);
    leftMix.connect(channelMerger, 0, 0);
    rightMix.connect(channelMerger, 0, 1);
    globalShaper = ctx.createWaveShaper();
    globalMaster = ctx.createGain(); globalMaster.gain.value = 1.0;
    channelMerger.connect(globalShaper).connect(globalMaster).connect(ctx.destination);

    // Drone chain
    osc1 = ctx.createOscillator(); osc2 = ctx.createOscillator();
    ampVCA = ctx.createGain(); ampVCA.gain.value = 0;
    waveShaper = ctx.createWaveShaper(); setDistortionCurve(0.08);
    filter = ctx.createBiquadFilter(); filter.type="lowpass"; filter.frequency.value=800; filter.Q.value=0.8;
    dronePan = safeStereoPanner(); if (dronePan.pan && dronePan.pan.setTargetAtTime) dronePan.pan.setTargetAtTime(-0.2, 0, 0.01);
    droneMaster = ctx.createGain(); droneMaster.gain.value = 0.35;
    convolver = ctx.createConvolver(); convolver.normalize = true;
    revWet = ctx.createGain(); revWet.gain.value = 0.55; revDry = ctx.createGain(); revDry.gain.value = 1;

    osc1.connect(ampVCA); osc2.connect(ampVCA);
    ampVCA.connect(waveShaper); waveShaper.connect(filter);
    filter.connect(revDry); filter.connect(convolver);
    convolver.connect(revWet).connect(dronePan).connect(droneMaster);
    revDry.connect(dronePan).connect(droneMaster);

    anaDrone = ctx.createAnalyser(); anaDrone.fftSize=1024;
    droneMaster.connect(anaDrone);
    try{ ringDrone = new Float32Array(Math.max(2048, Math.floor((ctx.sampleRate||44100)*2))); ringPos=0; }catch(e){ ringDrone=null; }
    droneMaster.connect(leftMix); droneMaster.connect(rightMix);

    // LFO
    lfoOsc = ctx.createOscillator(); lfoOsc.frequency.value = 0.07;
    lfoGain = ctx.createGain(); lfoGain.gain.value = 0.5;
    lfoOsc.connect(lfoGain); lfoOsc.start(); setLfoTarget('filter');

    // Drums chain
    drumHPF = ctx.createBiquadFilter(); drumHPF.type='highpass'; drumHPF.frequency.value=50;
    drumLPF = ctx.createBiquadFilter(); drumLPF.type='lowpass'; drumLPF.frequency.value=16000;
    drumShaper = ctx.createWaveShaper(); setDrumDrive(0.15);
    drumComp = ctx.createDynamicsCompressor();
    drumComp.threshold.value = -18; drumComp.knee.value = 12; drumComp.ratio.value = 4;
    drumComp.attack.value = 0.003; drumComp.release.value = 0.15;
    drumPanNode = safeStereoPanner(); if (drumPanNode.pan && drumPanNode.pan.setTargetAtTime) drumPanNode.pan.setTargetAtTime(0.25, 0, 0.01);
    drumMaster = ctx.createGain(); drumMaster.gain.value = 0.9;
    drumDry = ctx.createGain(); drumDry.gain.value = 1;
    drumSend = ctx.createGain(); drumSend.gain.value = 0.3;
    drumHPF.connect(drumLPF).connect(drumShaper).connect(drumComp);
    drumComp.connect(drumDry); drumDry.connect(drumPanNode).connect(drumMaster);
    drumComp.connect(drumSend).connect(convolver);

    anaDrum = ctx.createAnalyser(); anaDrum.fftSize=1024;
    drumMaster.connect(anaDrum);
    drumMaster.connect(leftMix); drumMaster.connect(rightMix);

    osc1.start(); osc2.start();
  }

  function setDistortionCurve(amount){
    var k = Math.max(0, Math.min(1, amount)) * 100, n = 8192, curve = new Float32Array(n);
    for (var i=0;i<n;i++){ var x=(i*2/n)-1; curve[i] = (1 + 0.2*x) * Math.tanh(k*x) / Math.tanh(k||1); }
    waveShaper.curve = curve; waveShaper.oversample = '4x';
  }
  
  function setGlobalDrive(amount){
    if (!ctx) return;
    var k = Math.max(0, Math.min(1, amount)) * 70, n = 4096, curve = new Float32Array(n);
    for (var i=0;i<n;i++){ var x=(i*2/n)-1; curve[i] = Math.tanh(k*x); }
    if (typeof globalShaper !== 'undefined') { globalShaper.curve = curve; globalShaper.oversample = '4x'; }
  }

  function setDrumDrive(amount){
    var k = Math.max(0, Math.min(1, amount)) * 80, n = 4096, curve = new Float32Array(n);
    for (var i=0;i<n;i++){ var x=(i*2/n)-1; curve[i] = Math.tanh(k*x); }
    drumShaper.curve = curve; drumShaper.oversample = '4x';
  }
  function updateReverbIR(decaySec, size){
    if (!ctx) return;
    var rate = ctx.sampleRate; var length = Math.floor(Math.max(0.2, Math.min(60, decaySec))*rate);
    var ir = ctx.createBuffer(2, length, rate);
    for (var ch=0; ch<2; ch++) {
      var data = ir.getChannelData(ch);
      var taps = Math.floor(length * Math.max(0.1, Math.min(1, size)) * 0.05) + 2000;
      for (var t=0;t<taps;t++){ var idx=Math.floor(Math.random()*length); var s=Math.random()>0.5?1:-1; data[idx]+= s*(0.2+Math.random()*0.8); }
      var g=1, decay=Math.exp(-3/(rate*Math.max(0.2, Math.min(60, decaySec))));
      for (var i=1;i<length;i++){ g*=decay; data[i]=(data[i]+data[i-1])*0.5*g; }
      var prev=data[0], a=0.12; for (var i=1;i<length;i++){ prev=prev+a*(data[i]-prev); data[i]=prev; }
      var peak=0; for (var i=0;i<length;i++) peak=Math.max(peak, Math.abs(data[i]));
      var norm = peak>0 ? 0.9/peak : 1; for (var i=0;i<length;i++) data[i]*=norm;
    }
    convolver.buffer = ir;
  }

  function disconnectLfo(){ try{ lfoGain.disconnect(); }catch(e){} }
  function setLfoTarget(target){
    disconnectLfo();
    if (target==='filter') lfoGain.connect(filter.frequency);
    else if (target==='amp') lfoGain.connect(ampVCA.gain);
    else if (target==='pitch'){ lfoGain.connect(osc1.detune); lfoGain.connect(osc2.detune); }
  }

  function setOscWave(type){ osc1.type=type; osc2.type=type; }
  function setBaseFrequencyFromMidi(note){ var f=noteToFreq(note); osc1.frequency.setTargetAtTime(f, ctx.currentTime, 0.02); osc2.frequency.setTargetAtTime(f, ctx.currentTime, 0.02); }
  function setDetuneCents(c){ osc1.detune.setTargetAtTime(-c, ctx.currentTime, 0.02); osc2.detune.setTargetAtTime(+c, ctx.currentTime, 0.02); }
  function setStereoSpread(spread){ leftMix.gain.setTargetAtTime(0.98 + spread*0.02, ctx.currentTime, 0.02); rightMix.gain.setTargetAtTime(0.98 - spread*0.02, ctx.currentTime, 0.02); }
  function envGateOn(){ var t=ctx.currentTime; ampVCA.gain.cancelScheduledValues(t); ampVCA.gain.setValueAtTime(ampVCA.gain.value,t); ampVCA.gain.linearRampToValueAtTime(0.9, t+0.6); }
  function envGateOff(){ var t=ctx.currentTime; ampVCA.gain.cancelScheduledValues(t); ampVCA.gain.setValueAtTime(ampVCA.gain.value,t); ampVCA.gain.linearRampToValueAtTime(0, t+1.2); }
  function quickSilence(){ if (!ctx) return; ampVCA.gain.cancelScheduledValues(ctx.currentTime); ampVCA.gain.setTargetAtTime(0, ctx.currentTime, 0.01); }

  function secondsPerStep(){ return 60.0/tempo/2.0; }
  function scheduleStep(step, time){
    highlightStep(step);
    var accent = seq.accent[step] ? 1.6 : 1.0;
    if (seq.kick[step])  hitKick(time, 1.0*accent);
    if (seq.snare[step]) hitSnare(time, 1.0*accent);
    if (seq.hat[step])   hitHat(time, 0.9*accent);
  }
  function scheduler(){
    while (ctx.currentTime + 0.15 >= nextNoteTime){
      var stepTime = nextNoteTime;
      var spd = secondsPerStep();
      var swing = swingPct / 100 * 0.5 * spd;
      if (currentStep % 2 === 1) stepTime += swing;
      scheduleStep(currentStep, stepTime);
      nextNoteTime += spd;
      currentStep = (currentStep+1) % steps;
    }
  }
  function startSequencer(){ if (!ctx || isSequencing) return; nextNoteTime = ctx.currentTime + 0.05; schedulerTimer = setInterval(scheduler, 25.0); isSequencing = true; }
  function stopSequencer(){ if (!isSequencing) return; clearInterval(schedulerTimer); isSequencing=false; unhighlightAll(); }

  function hitKick(time, amp){ if (amp==null) amp=1;
    var o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(140,time); o.frequency.exponentialRampToValueAtTime(45,time+0.14);
    g.gain.setValueAtTime(1.0*amp,time); g.gain.exponentialRampToValueAtTime(0.0008,time+0.3); o.connect(g).connect(drumHPF); o.start(time); o.stop(time+0.32);
    var c=ctx.createOscillator(), cg=ctx.createGain(); c.type='square'; c.frequency.setValueAtTime(1800,time); cg.gain.setValueAtTime(0.16*amp,time); cg.gain.exponentialRampToValueAtTime(0.0001,time+0.018); c.connect(cg).connect(drumHPF); c.start(time); c.stop(time+0.02);
  }
  function hitSnare(time, amp){ if (amp==null) amp=1;
    var noise=ctx.createBufferSource(); var len=Math.floor(ctx.sampleRate*0.22); var buf=ctx.createBuffer(1,len,ctx.sampleRate); var d=buf.getChannelData(0); for(var i=0;i<len;i++) d[i]=Math.random()*2-1; noise.buffer=buf;
    var bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1600; bp.Q.value=0.8;
    var g=ctx.createGain(); g.gain.setValueAtTime(0.7*amp,time); g.gain.exponentialRampToValueAtTime(0.0001,time+0.22);
    noise.connect(bp).connect(g).connect(drumHPF); noise.start(time); noise.stop(time+0.23);
    var tone=ctx.createOscillator(), tg=ctx.createGain(); tone.type='triangle'; tone.frequency.setValueAtTime(220,time); tg.gain.setValueAtTime(0.12*amp,time); tg.gain.exponentialRampToValueAtTime(0.0001,time+0.08); tone.connect(tg).connect(drumHPF); tone.start(time); tone.stop(time+0.09);
  }
  function hitHat(time, amp){ if (amp==null) amp=1;
    var noise=ctx.createBufferSource(); var len=Math.floor(ctx.sampleRate*0.1); var buf=ctx.createBuffer(1,len,ctx.sampleRate); var d=buf.getChannelData(0); for(var i=0;i<len;i++) d[i]=(Math.random()*2-1)*0.8; noise.buffer=buf;
    var hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=1.0;
    var g=ctx.createGain(); g.gain.setValueAtTime(0.45*amp,time); g.gain.exponentialRampToValueAtTime(0.0001,time+0.09);
    noise.connect(hp).connect(g).connect(drumHPF); noise.start(time); noise.stop(time+0.1);
  }

  function visibleIndex(i){ return i; }
  function rebuildSequencerUI(){
    document.documentElement.style.setProperty('--vissteps', 16);
    var head=$('seqHead'); head.innerHTML='<div></div>'; for(var i=0;i<16;i++){ var d=document.createElement('div'); d.className='stepNum'; d.textContent=(visibleIndex(i)+1); head.appendChild(d); }
    buildRow('Accent','accent'); buildRow('Kick','kick'); buildRow('Snare','snare'); buildRow('Hat','hat');
    $('pageLabel').textContent = '16 SEQUENCE';
  }
  function buildRow(label, key){
    var id = 'seq'+label; var el=$(id); el.innerHTML='';
    var lab = document.createElement('div'); lab.className='label'; lab.textContent=label; el.appendChild(lab);
    for(let i=0;i<16;i++){ (function(i){
      var cell=document.createElement('div'); var idx=visibleIndex(i); cell.className='cell '+(seq[key][idx]?'on':'off');
      cell.onclick=function(){ var k=visibleIndex(i); seq[key][k]=!seq[key][k]; cell.className='cell '+(seq[key][k]?'on':'off'); autoSave(); };
      el.appendChild(cell);
    })(i); }
  }
  function updateAllRowsUI(){
    ['accent','kick','snare','hat'].forEach(function(key){
      var row = document.getElementById('seq'+key.charAt(0).toUpperCase()+key.slice(1));
      var kids = Array.prototype.slice.call(row.children);
      kids.forEach(function(c, idx){ if (idx===0) return; var k=visibleIndex(idx-1); c.className='cell '+(seq[key][k]?'on':'off'); });
    });
    var headKids = Array.prototype.slice.call($('seqHead').children);
    headKids.forEach(function(c, idx){ if (idx===0) return; c.textContent = visibleIndex(idx-1)+1; });
  }
  function highlightStep(i){
    ['Accent','Kick','Snare','Hat'].forEach(function(name){
      var row = $('seq'+name);
      var kids = Array.prototype.slice.call(row.children);
      kids.forEach(function(c, idx){
        if (idx===0) return;
        var k=visibleIndex(idx-1);
        c.classList.toggle('play', k===i);
      });
    });
  }
  function unhighlightAll(){ ['Accent','Kick','Snare','Hat'].forEach(function(name){ var row=$('seq'+name); var kids=Array.prototype.slice.call(row.children); kids.forEach(function(c,idx){ if (idx>0) c.classList.remove('play'); }); }); }

  function randomFill(mode){
    var kdBase = {sparse:.2, groove:.35, dense:.5}[mode]||.2;
    var sdBase = {sparse:.15, groove:.25, dense:.4}[mode]||.15;
    var hdBase = {sparse:.5, groove:.6, dense:.8}[mode]||.5;
    for (var i=0;i<steps;i++){
      var down = (i===0 || i===Math.floor(steps/2));
      seq.kick[i] = Math.random() < (down ? kdBase+0.2 : kdBase);
      seq.snare[i]= Math.random() < (i%(steps/4)===Math.floor(steps/8) ? sdBase+0.2 : sdBase);
      seq.hat[i]  = Math.random() < hdBase;
      seq.accent[i] = Math.random() < (down ? .3 : .15);
    }
    updateAllRowsUI(); autoSave();
  }
  function clearSeq(){ ['accent','kick','snare','hat'].forEach(function(k){ for(var i=0;i<steps;i++) seq[k][i]=false; }); updateAllRowsUI(); autoSave(); }

  function populateNotes(){ var sel=$('noteRoot'); NOTE_NAMES.forEach(function(n){ var o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); sel.value='C'; }
  function buildPresets(){
    var presets = [
      { id:"deep-bloom", name:"Deep Bloom (LPF drift)", params:{ wave:"sine", cutoff:650, resonance:0.7, lfoTarget:"filter", lfoRate:0.05, lfoDepth:0.55, detune:9, spread:0.7, master:0.32, distAmt:0.04, revDecay:13, revSize:0.95, revWet:0.6, note:"D", octave:3 } },
      { id:"cathedral-drift", name:"Cathedral Drift (big tail)", params:{ wave:"triangle", cutoff:900, resonance:0.9, lfoTarget:"filter", lfoRate:0.03, lfoDepth:0.65, detune:12, spread:0.8, master:0.3, distAmt:0.03, revDecay:20, revSize:1.0, revWet:0.72, note:"C", octave:3 } },
      { id:"tape-haze", name:"Tape Haze (amp wobble + grit)", params:{ wave:"sine", cutoff:1200, resonance:0.6, lfoTarget:"amp", lfoRate:0.12, lfoDepth:0.18, detune:7, spread:0.6, master:0.34, distAmt:0.12, revDecay:11, revSize:0.9, revWet:0.48, note:"F", octave:2 } },
      { id:"shimmer-lite", name:"Shimmer‑Lite (bright pad)", params:{ wave:"sawtooth", cutoff:3000, resonance:0.5, lfoTarget:"pitch", lfoRate:0.06, lfoDepth:0.1, detune:14, spread:0.75, master:0.28, distAmt:0.06, revDecay:15, revSize:0.96, revWet:0.65, note:"A", octave:3 } }
    ,
      { id:"glacial-shelf", name:"Glacial Shelf (ultra‑slow LPF drift)", params:{ wave:"sine", cutoff:520, resonance:0.95, lfoTarget:"filter", lfoRate:0.010, lfoDepth:0.60, detune:11, spread:0.80, master:0.30, distAmt:0.03, revDecay:30, revSize:1.00, revWet:0.72, note:"D", octave:2 } },
      { id:"permafrost-choir", name:"Permafrost Choir (wide triangles)", params:{ wave:"triangle", cutoff:1000, resonance:0.85, lfoTarget:"filter", lfoRate:0.014, lfoDepth:0.55, detune:12, spread:0.85, master:0.28, distAmt:0.02, revDecay:26, revSize:0.98, revWet:0.70, note:"A", octave:2 } },
      { id:"ice-fog", name:"Ice Fog (amp wander)", params:{ wave:"sine", cutoff:880, resonance:0.75, lfoTarget:"amp", lfoRate:0.020, lfoDepth:0.34, detune:9, spread:0.70, master:0.32, distAmt:0.04, revDecay:22, revSize:0.96, revWet:0.62, note:"F", octave:2 } },
      { id:"slow-tectonics", name:"Slow Tectonics (low, heavy saw)", params:{ wave:"sawtooth", cutoff:700, resonance:1.10, lfoTarget:"filter", lfoRate:0.007, lfoDepth:0.50, detune:14, spread:0.78, master:0.29, distAmt:0.05, revDecay:25, revSize:0.97, revWet:0.66, note:"C", octave:2 } },
      { id:"polar-night", name:"Polar Night (glacial tide)", params:{ wave:"sine", cutoff:580, resonance:0.90, lfoTarget:"filter", lfoRate:0.006, lfoDepth:0.68, detune:10, spread:0.82, master:0.30, distAmt:0.03, revDecay:34, revSize:1.00, revWet:0.74, note:"D#", octave:2 } },
      { id:"midnight-fjord", name:"Midnight Fjord (amp sway + tone)", params:{ wave:"triangle", cutoff:950, resonance:0.80, lfoTarget:"amp", lfoRate:0.012, lfoDepth:0.28, detune:10, spread:0.76, master:0.31, distAmt:0.04, revDecay:24, revSize:0.97, revWet:0.64, note:"G", octave:2 } },
      { id:"aurora-drift", name:"Aurora Drift (soft shimmer)", params:{ wave:"sawtooth", cutoff:2200, resonance:0.55, lfoTarget:"pitch", lfoRate:0.018, lfoDepth:0.06, detune:15, spread:0.80, master:0.27, distAmt:0.06, revDecay:18, revSize:0.96, revWet:0.60, note:"E", octave:3 } },
      { id:"still-tundra", name:"Still Tundra (subtle breath)", params:{ wave:"sine", cutoff:760, resonance:0.80, lfoTarget:"filter", lfoRate:0.009, lfoDepth:0.55, detune:8, spread:0.70, master:0.30, distAmt:0.03, revDecay:20, revSize:0.95, revWet:0.62, note:"D", octave:2 } },
      { id:"frozen-cathedral", name:"Frozen Cathedral (endless tail)", params:{ wave:"triangle", cutoff:840, resonance:1.00, lfoTarget:"filter", lfoRate:0.008, lfoDepth:0.65, detune:13, spread:0.84, master:0.28, distAmt:0.03, revDecay:40, revSize:1.00, revWet:0.76, note:"C", octave:3 } },
      { id:"blue-hour-haze", name:"Blue Hour Haze (amp wobble)", params:{ wave:"sine", cutoff:1100, resonance:0.70, lfoTarget:"amp", lfoRate:0.016, lfoDepth:0.22, detune:9, spread:0.72, master:0.33, distAmt:0.04, revDecay:21, revSize:0.95, revWet:0.60, note:"A#", octave:2 } }];
    var sel = $('presetSelect'); presets.forEach(function(p){ var o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
    sel.dataset.presets = JSON.stringify(presets); sel.value="cathedral-drift";
  }
  function applyPreset(id){
    var sel=$('presetSelect'); var presets=JSON.parse(sel.dataset.presets||"[]"); var p=presets.find(function(x){ return x.id===id; }); if(!p) return;
    var v=p.params;
    $('wave').value=v.wave; $('cutoff').value=v.cutoff; $('cutoffNum').value=v.cutoff; $('resonance').value=v.resonance; $('resonanceNum').value=v.resonance;
    $('lfoTarget').value=v.lfoTarget; $('lfoRate').value=v.lfoRate; $('lfoRateNum').value=v.lfoRate; $('lfoDepth').value=v.lfoDepth; $('lfoDepthNum').value=v.lfoDepth;
    $('detune').value=v.detune; $('detuneNum').value=v.detune; $('spread').value=v.spread; $('spreadNum').value=v.spread;
    $('master').value=v.master; $('masterNum').value=v.master; $('distAmt').value=v.distAmt; $('distAmtNum').value=v.distAmt;
    $('revDecay').value=v.revDecay; $('revDecayNum').value=v.revDecay; $('revSize').value=v.revSize; $('revSizeNum').value=v.revSize; $('revWet').value=v.revWet; $('revWetNum').value=v.revWet;
    $('noteRoot').value=v.note; $('octave').value=v.octave;
    if (ctx) updateReverbIR(+v.revDecay, +v.revSize);
    pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}

      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 autoSave();
    if (ctx && $('holdToggle').checked) { setBaseFrequencyFromMidi(nameOctToMidi(v.note, +v.octave)); envGateOn(); }
  }

  function buildDrumPresets(){
    var p = [
      {id:"empty", name:"— Empty —", pat:makeEmptySeq(steps), fx:{hpf:50, lpf:16000, drive:0.15, comp:true, send:0.3}},
      {id:"heartbeat", name:"Heartbeat (1 & 5 + hats)", pat:seedPattern([[ 'kick',[0, 8] ],['hat',[0, 2, 4, 6, 8, 10, 12, 14] ] ]), fx:{hpf:40, lpf:14000, drive:0.1, comp:true, send:0.25}},
      {id:"dub-wash", name:"Dub Wash", pat:seedPattern([[ 'kick',[0, 6, 8, 14] ],['snare',[4, 12] ],['hat',[0, 2, 4, 6, 8, 10, 12, 14] ] ]), fx:{hpf:60, lpf:12000, drive:0.2, comp:true, send:0.5}},
      {id:"slow-march", name:"Slow March", pat:seedPattern([[ 'kick',[0, 3, 4, 7, 8, 11, 12, 15] ],['snare',[2, 6, 10, 14] ],['hat',[0, 2, 4, 6, 8, 10, 12, 14] ] ]), fx:{hpf:55, lpf:10000, drive:0.18, comp:true, send:0.35}},
      {id:"shimmer-ghosts", name:"Shimmer Ghosts", pat:seedPattern([[ 'kick',[0, 8] ],['snare',[0, 8] ],['hat',[1, 3, 5, 7, 9, 11, 13, 15] ] ]), fx:{hpf:80, lpf:16000, drive:0.12, comp:false, send:0.6}},
      {id:"house-4x4", name:"House — 4×4", pat:seedPattern([[ 'kick',[0,4,8,12] ],['snare',[4,12] ],['hat',[0,2,4,6,8,10,12,14] ],['accent',[0,8] ]]), fx:{hpf:60, lpf:15000, drive:0.18, comp:true, send:0.45}},
      {id:"hiphop-half", name:"Hip‑Hop — Half‑Time", pat:seedPattern([[ 'kick',[0,7,10] ],['snare',[12,4] ],['hat',[0,2,4,6,8,10,12,14] ],['accent',[0,12] ]]), fx:{hpf:55, lpf:12000, drive:0.22, comp:true, send:0.35}},
      {id:"dub-steppers", name:"Dub Steppers", pat:seedPattern([[ 'kick',[0,8,11] ],['snare',[6,14] ],['hat',[2,6,10,14] ],['accent',[6] ]]), fx:{hpf:45, lpf:10000, drive:0.2, comp:true, send:0.6}},
      {id:"break-skippy", name:"Break — Skippy", pat:seedPattern([[ 'kick',[0,3,8,11] ],['snare',[4,12] ],['hat',[2,5,6,9,10,13,14] ],['accent',[11] ]]), fx:{hpf:70, lpf:14000, drive:0.16, comp:true, send:0.4}},
      {id:"minimal-tech", name:"Minimal Tech", pat:seedPattern([[ 'kick',[0,8] ],['snare',[4,12] ],['hat',[0,4,8,12] ],['accent',[0,8] ]]), fx:{hpf:80, lpf:16000, drive:0.12, comp:false, send:0.3}},
      {id:"triplet-hats", name:"Triplet‑ish Hats", pat:seedPattern([[ 'kick',[0,8] ],['snare',[4,12] ],['hat',[0,3,6,8,11,14] ],['accent',[0,6,8,14] ]]), fx:{hpf:65, lpf:13000, drive:0.14, comp:true, send:0.5}},

    ];
    var sel=$('drumPreset'); p.forEach(function(d){ var o=document.createElement('option'); o.value=d.id; o.textContent=d.name; sel.appendChild(o); });
    sel.dataset.pats = JSON.stringify(p); sel.value="heartbeat";
  }
  function seedPattern(pairs){
    var s = makeEmptySeq(steps);
    pairs.forEach(function(pair){
      var name = pair[0], idxs = pair[1];
      idxs.forEach(function(i){ var k=i%steps; s[name][k]=true; });
    });
    return s;
  }

  function applyDrumPreset(id){
    var sel=$('drumPreset'); var bank=JSON.parse(sel.dataset.pats||"[]"); var p=bank.find(function(x){ return x.id===id; }); if(!p) return;
    seq = JSON.parse(JSON.stringify(p.pat));
    updateAllRowsUI();
    $('drumHPF').value=p.fx.hpf; $('drumHPFNum').value=p.fx.hpf;
    $('drumLPF').value=p.fx.lpf; $('drumLPFNum').value=p.fx.lpf;
    $('drumDrive').value=p.fx.drive; $('drumDriveNum').value=p.fx.drive;
    $('drumComp').checked=!!p.fx.comp;
    $('drumRevSend').value=p.fx.send; $('drumRevSendNum').value=p.fx.send;
    pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 autoSave();
  }

  /* --- Save/Load/Reset --- */
  function collectState(){
    return {
      version: "2.7.0",
      drone: {
        preset: $('presetSelect').value, wave:$('wave').value,
        note:$('noteRoot').value, octave:+$('octave').value,
        detune:+$('detune').value, spread:+$('spread').value, volume:+$('master').value, pan:+$('dronePan').value, hold:$('holdToggle').checked,
        filterType:$('filterType').value, cutoff:+$('cutoff').value, resonance:+$('resonance').value,
        lfoTarget:$('lfoTarget').value, lfoRate:+$('lfoRate').value, lfoDepth:+$('lfoDepth').value,
        dist:+$('distAmt').value, revDecay:+$('revDecay').value, revSize:+$('revSize').value, revWet:+$('revWet').value
      },
      drums: {
        preset:$('drumPreset').value, tempo:+$('tempo').value, swing:+$('swing').value,
        pan:+$('drumPan').value, volume:+$('drumVol').value,
        hpf:+$('drumHPF').value, lpf:+$('drumLPF').value, drive:+$('drumDrive').value, comp:$('drumComp').checked, send:+$('drumRevSend').value,
        seq: seq
      },
      ui: { grid:$('gridOn').checked, persist:$('persistOn').checked, glow:+$('glow').value, page:page }
    };
  }
  function applyState(S){
    if (!S) return;
    try{
      $('presetSelect').value=S.drone.preset||$('presetSelect').value;
      $('wave').value=S.drone.wave||'sawtooth';
      $('noteRoot').value=S.drone.note||'D';
      $('octave').value=S.drone.octave||2;
      setPair('detune', S.drone.detune);
      setPair('spread', S.drone.spread);
      setPair('master', S.drone.volume);
      setPair('dronePan', S.drone.pan);
      $('holdToggle').checked=!!S.drone.hold;
      $('filterType').value=S.drone.filterType||'lowpass';
      setPair('cutoff', S.drone.cutoff);
      setPair('resonance', S.drone.resonance);
      $('lfoTarget').value=S.drone.lfoTarget||'filter';
      setPair('lfoRate', S.drone.lfoRate);
      setPair('lfoDepth', S.drone.lfoDepth);
      setPair('distAmt', S.drone.dist);
      setPair('revDecay', S.drone.revDecay);
      setPair('revSize', S.drone.revSize);
      setPair('revWet', S.drone.revWet);

      $('drumPreset').value=S.drums.preset||$('drumPreset').value;
      setPair('tempo', S.drums.tempo);
      setPair('swing', S.drums.swing);
      setPair('drumPan', S.drums.pan);
      setPair('drumVol', S.drums.volume);
      setPair('drumHPF', S.drums.hpf);
      setPair('drumLPF', S.drums.lpf);
      setPair('drumDrive', S.drums.drive);
      $('drumComp').checked=!!S.drums.comp;
      setPair('drumRevSend', S.drums.send);
      if (S.drums.seq){ seq=S.drums.seq; updateAllRowsUI(); }

      $('gridOn').checked = !!S.ui.grid;
      $('persistOn').checked = !!S.ui.persist;
      $('glow').value = +S.ui.glow || 6;
      page = S.ui.page || 0; rebuildSequencerUI();
      pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}

    }catch(e){ console.warn('applyState failed', e); }
  }
  function saveState(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectState())); }catch(e){ console.warn('saveState',e); } }
  function loadState(){ try{ var raw=localStorage.getItem(STORE_KEY); if (!raw) return null; var S=JSON.parse(raw); applyState(S); return S; }catch(e){ console.warn('loadState',e); return null; } }
  
function resetState(){
  try { localStorage.removeItem(STORE_KEY); } catch(e){}
  try {
    if ($('globalVol')) $('globalVol').value = 0.534;
    if ($('globalDrive')) $('globalDrive').value = 0.013;
    if ($('revWetTop')) $('revWetTop').value = 0.348;
    if ($('tempoTop')) $('tempoTop').value = 60;

    try { applyPreset('cathedral-drift'); } catch(e){}
    if ($('octave')) $('octave').value = 2;
    if ($('noteRoot')) $('noteRoot').value = 'C';
    if ($('detune')) { $('detune').value = 12; $('detuneNum').value = 12; }
    if ($('spread')) { $('spread').value = 0.8; $('spreadNum').value = 0.8; }
    if ($('master')) { $('master').value = 0.3; $('masterNum').value = 0.3; }
    if ($('dronePan')) { $('dronePan').value = -0.2; $('dronePanNum').value = -0.2; }
    if ($('holdToggle')) $('holdToggle').checked = true;
    if ($('filterType')) $('filterType').value = 'lowpass';
    if ($('cutoff')) { $('cutoff').value = 900; $('cutoffNum').value = 900; }
    if ($('resonance')) { $('resonance').value = 0.9; $('resonanceNum').value = 0.9; }

    if ($('trigOn')) $('trigOn').checked = true;
    if ($('timeWindow')) $('timeWindow').value = '0.5';
    if ($('yZoom')) $('yZoom').value = 2;
    if ($('gridOn')) $('gridOn').checked = true;
    if ($('persistOn')) $('persistOn').checked = true;

    pushUIToEngine();
    try{ if(ctx && globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime, 0.01); }catch(e){}
    try{ autoSave(); }catch(e){}
  } catch(e){
    console.warn('resetState defaults failed; reloading', e);
    try { location.reload(); } catch(_) {}
  }
}

  function autoSave(){ saveState(); }

  /* --- Visualizer (hotfix+Eurorack) --- */
  function sizeCanvas(c, pxH){
    if (!c) return;
    var dpr = Math.max(1, window.devicePixelRatio || 1);
    var rect = c.getBoundingClientRect();
    var pw = rect.width || (c.parentElement ? c.parentElement.clientWidth : 640);
    c.width = Math.max(320, Math.floor(pw * dpr));
    c.height = Math.floor((pxH||240) * dpr);
    return {dpr, pw};
    if (!c) return;
    var dpr = Math.max(1, window.devicePixelRatio || 1);
    var rect = c.getBoundingClientRect();
    c.width = Math.max(320, Math.floor(rect.width * dpr));
    c.height = Math.floor((pxH||120) * dpr);
  }
  function startViz(){
    if (!ctx || !anaDrone || !anaDrum) return;
    var c1 = $('vizDrone'), c2 = $('vizDrum');
    if (!c1 || !c2) return;
    scopesEnabled = true;
    try{ cancelAnimationFrame(vizRAF); }catch(e){}
    var vw = (window.innerWidth||document.documentElement.clientWidth||0);
    var targetH = vw <= 768 ? 168 : 240;
    var card = document.querySelector('.card.card--scopes');
    if (card && (card.classList.contains('dockedBR') || card.classList.contains('floating'))) targetH = Math.min(targetH, 120);
    // If CSS height is set on canvas, prefer that visual height
    var cssH1 = parseFloat(getComputedStyle(c1).height)||targetH;
    var cssH2 = parseFloat(getComputedStyle(c2).height)||targetH;
    var cssH1 = parseFloat(getComputedStyle(c1).height)||120;
    var cssH2 = parseFloat(getComputedStyle(c2).height)||120;
    sizeCanvas(c1, cssH1); sizeCanvas(c2, cssH2);
    var g1 = c1.getContext('2d'), g2 = c2.getContext('2d');
    if (!g1 || !g2) return;
    var floatOK = !!anaDrone.getFloatTimeDomainData;
    function draw(){
      vizRAF = requestAnimationFrame(draw);
      if (!ctx || ctx.state!=='running') return;
      var n1 = anaDrone.fftSize, n2 = anaDrum.fftSize;
      var b1 = new Float32Array(n1);  // always float for ring buffer

      var b2 = floatOK ? new Float32Array(n2) : new Uint8Array(n2);
      if (floatOK){ anaDrone.getFloatTimeDomainData(b1); anaDrum.getFloatTimeDomainData(b2); }
      else { anaDrone.getByteTimeDomainData(b1); anaDrum.getByteTimeDomainData(b2); }
      renderScope(g1, c1, b1, floatOK);
      renderScope(g2, c2, b2, floatOK);
      updateRMS('rmsD', b1, floatOK);
      updateRMS('rmsB', b2, floatOK);
    }
    draw();
  }
  function stopViz(){ scopesEnabled=false; try{ cancelAnimationFrame(vizRAF); }catch(e){} }
  window.addEventListener('resize', function(){ if (scopesEnabled){ startViz(); } });
  document.addEventListener('visibilitychange', function(){ if (document.hidden) stopViz(); else setTimeout(function(){ try{ startViz(); }catch(e){} }, 0); });

  function updateRMS(id, buf, isFloat){
    var sum=0, n=buf.length;
    for (var i=0;i<n;i++){ var v=isFloat?buf[i]:(buf[i]/128-1); sum += v*v; }
    var rms = Math.sqrt(sum/n);
    var el=$(id); if(el){ el.style.width = Math.min(100, Math.round(rms*140)) + '%'; }
  }
  
function renderScope(g, canvas, buf, isFloat){
    var po=$('persistOn'); var persistence = !!(po && po.checked);
    var gl=$('glow'); var glow = gl ? +gl.value : 0;
    var go=$('gridOn'); var showGrid = !!(go && go.checked);

    // Background / persistence
    if (persistence){
      g.globalCompositeOperation = 'source-over';
      g.fillStyle = 'rgba(11,13,7,0.08)';
      g.fillRect(0,0,canvas.width,canvas.height);
    } else {
      g.globalCompositeOperation = 'source-over';
      g.fillStyle = '#0B0D07';
      g.fillRect(0,0,canvas.width,canvas.height);
    }

    // Optional grid
    if (showGrid){
      g.save();
      g.strokeStyle = '#2e3227';
      g.lineWidth = 1;
      // vertical
      for (var x=0; x<canvas.width; x+=Math.max(20, Math.floor(canvas.width/40))){
        g.beginPath(); g.moveTo(x,0); g.lineTo(x,canvas.height); g.stroke();
      }
      // horizontal
      for (var y=0; y<canvas.height; y+=Math.max(20, Math.floor(canvas.height/20))){
        g.beginPath(); g.moveTo(0,y); g.lineTo(canvas.width,y); g.stroke();
      }
      // center line
      g.strokeStyle = '#3A3F30'; g.lineWidth=1.5;
      g.beginPath(); g.moveTo(0, Math.floor(canvas.height*0.5)); g.lineTo(canvas.width, Math.floor(canvas.height*0.5)); g.stroke();
      g.restore();
    }

    // Waveform
    var step = Math.max(1, Math.floor(buf.length / canvas.width));
    var path = function(){
      g.beginPath();
      for (var x=0; x<canvas.width; x++){
        var v = buf[x*step]; var s = isFloat ? v : (v/128-1);
        var gain = (window.__scopeYZoom||1) * 0.45; var y = (0.5 - s*gain) * canvas.height;
        if (x===0) g.moveTo(x, y); else g.lineTo(x, y);
      }
    };

    // Glow pass (additive)
    if (glow>0){
      g.save();
      g.globalCompositeOperation = 'lighter';
      g.shadowColor = '#FFE900';
      g.shadowBlur  = glow;
      g.strokeStyle = '#FFE900';
      g.lineWidth = 3;
      path(); g.stroke();
      g.restore();
    }

    // Main line
    g.save();
    g.globalCompositeOperation = 'source-over';
    g.strokeStyle = '#FFE900';
    g.lineWidth = 2;
    path(); g.stroke();
    g.restore();
}


  function pushUIToEngine(){
    if (!ctx) return;
    setOscWave($('wave').value);
    filter.type = $('filterType').value;
    filter.frequency.setTargetAtTime(+$('cutoff').value, ctx.currentTime, 0.05);
    filter.Q.setTargetAtTime(+$('resonance').value, ctx.currentTime, 0.05);
    lfoOsc.frequency.setTargetAtTime(+$('lfoRate').value, ctx.currentTime, 0.05);
    setLfoTarget($('lfoTarget').value);
    lfoGain.gain.setTargetAtTime(+$('lfoDepth').value, ctx.currentTime, 0.05);
    setDetuneCents(+$('detune').value);
    setStereoSpread(+$('spread').value);
    droneMaster.gain.setTargetAtTime(+$('master').value, ctx.currentTime, 0.05);
    setDistortionCurve(+$('distAmt').value);
    revWet.gain.setTargetAtTime(+$('revWet').value, ctx.currentTime, 0.05);
    if (dronePan.pan && dronePan.pan.setTargetAtTime) dronePan.pan.setTargetAtTime(+$('dronePan').value, ctx.currentTime, 0.05);
    setBaseFrequencyFromMidi(nameOctToMidi($('noteRoot').value, +$('octave').value));

    tempo = +$('tempo').value; $('tempoNum').value = tempo;
    $('bpmRead').textContent = tempo + ' BPM';
    swingPct = +$('swing').value; $('swingNum').value = swingPct;
    $('swingOut') ? $('swingOut').textContent = swingPct : null;
    drumMaster.gain.setTargetAtTime(+$('drumVol').value, ctx.currentTime, 0.02);
    if (drumPanNode.pan && drumPanNode.pan.setTargetAtTime) drumPanNode.pan.setTargetAtTime(+$('drumPan').value, ctx.currentTime, 0.02);
    drumHPF.frequency.setTargetAtTime(+$('drumHPF').value, ctx.currentTime, 0.02);
    drumLPF.frequency.setTargetAtTime(+$('drumLPF').value, ctx.currentTime, 0.02);
    setDrumDrive(+$('drumDrive').value);
    drumSend.gain.setTargetAtTime(+$('drumRevSend').value, ctx.currentTime, 0.02);
  }

  function hookPairs(){
    // Connect each range with its numeric twin bi-directionally
    [
      'detune','spread','master','dronePan','cutoff','resonance','lfoRate','lfoDepth','distAmt','revDecay','revSize','revWet',
      'tempo','swing','drumPan','drumVol','drumHPF','drumLPF','drumDrive','drumRevSend'
    ].forEach(id => {
      var r = $(id), n = $(id+'Num');
      if (!r || !n) return;
      r.addEventListener('input', () => { n.value = r.value; pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 autoSave(); if (id==='revDecay' || id==='revSize') updateReverbIR(+$('revDecay').value, +$('revSize').value); });
      n.addEventListener('input', () => {
        var v = clamp(+n.value || +r.min, +r.min, +r.max); n.value = v; r.value = v;
        if (id==='tempo'){ $('tempo').value=v; $('tempoNum').value=v; }
        if (id==='swing'){ $('swing').value=v; $('swingNum').value=v; }
        pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 autoSave();
        if (id==='revDecay' || id==='revSize') updateReverbIR(+$('revDecay').value, +$('revSize').value);
      });
    });
  }
  function setPair(id, val){ if (val==null) return; $(id).value=val; if ($(id+'Num')) $(id+'Num').value=val; }

  function hookUI(){
    $('startBtn').onclick = function(){
      try {
        if (!started){ createAudio(); started=true; }
        if (ctx.state!=='running'){
          ctx.resume().then(function(){ afterStart(); }).catch(function(err){ showErr('Resume failed: '+err.message); });
        } else { afterStart(); }
      } catch(err){ showErr('Start error: '+err.message); }
    };
    function afterStart(){
      running=true; $('stopBtn').disabled=false;
      $('wave').value = 'triangle'; $('octave').value = 2;
      updateReverbIR(+$('revDecay').value, +$('revSize').value);
      setBaseFrequencyFromMidi(nameOctToMidi($('noteRoot').value||'D', +$('octave').value||2));
      setOscWave('sawtooth');
      ampVCA.gain.cancelScheduledValues(ctx.currentTime);
      ampVCA.gain.setValueAtTime(0, ctx.currentTime);
      ampVCA.gain.linearRampToValueAtTime(0.9, ctx.currentTime + 0.3);
      if ($('holdToggle').checked) envGateOn();
      startSequencer();
      pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}

      setTimeout(function(){ try{ startViz(); }catch(e){} }, 0);
    }

    $('stopBtn').onclick = function(){ if (ctx && running){ running=false; ctx.suspend().then(function(){ stopSequencer(); stopViz(); }); } };
    $('panicBtn').onclick = quickSilence;
    $('rebuildBtn').onclick = function(){ try { if (ctx){ ctx.close().catch(function(){}); } } finally { started=false; running=false; createAudio(); setTimeout(function(){ try{ startViz(); }catch(e){} }, 0); } };
    (function(){
      var tb = $('tapBtn');
      if (!tb) return;
      if (typeof addTap === 'function'){
        tb.onclick = addTap;
      } else {
        // Fallback tap-tempo if addTap is out of scope
        var __taps = [];
        tb.onclick = function(){
          try {
            var now = performance.now();
            __taps.push(now);
            if (__taps.length>8) __taps.shift();
            if (__taps.length>=4){
              var intervals = [];
              for (var i=1;i<__taps.length;i++) intervals.push(__taps[i]-__taps[i-1]);
              intervals.sort(function(a,b){ return a-b; });
              var mid = Math.floor(intervals.length/2);
              var median = intervals.length%2 ? intervals[mid] : (intervals[mid-1]+intervals[mid])/2;
              var filtered = intervals.filter(function(iv){ return Math.abs(iv-median) < median*0.4; });
              var avg = filtered.reduce(function(s,v){ return s+v; },0)/filtered.length;
              var bpm = Math.round(60000/avg);
              bpm = Math.min(300, Math.max(5, bpm));
              var tEl = $('tempo'), nEl = $('tempoNum');
              if (tEl){ tEl.value = bpm; }
              if (nEl){ nEl.value = bpm; }
              // Trigger engine update if available
              try { if (typeof pushUIToEngine==='function') pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 } catch(e){}
              try { if (typeof autoSave==='function') autoSave(); } catch(e){}
              var br = $('bpmRead'); if (br) br.textContent = bpm + ' BPM';
            }
          } catch(e){ console.warn('tap fallback failed', e); }
        };
      }
    })();
    $('saveBtn').onclick = function(){ saveState(); };
    $('loadBtn').onclick = function(){ var __loaded = loadState();
    if (!__loaded) { try { applyPreset('cathedral-drift'); $('octave').value = 2; } catch(e){} }
 };
    $('resetBtn').onclick = function(){ resetState(); };

    ['wave','filterType','lfoTarget','noteRoot','octave','holdToggle','drumComp','presetSelect','drumPreset']
      .forEach(id => { var el=$(id); if(!el) return; el.addEventListener('change', ()=>{ if(id==='presetSelect') applyPreset($(id).value); else if(id==='drumPreset') applyDrumPreset($(id).value); else { pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 } autoSave(); }); });

    // Show scopes toggle
    var sc = $('scopesOn'); if (sc){ sc.addEventListener('change', function(){ if (sc.checked){ startViz(); } else { stopViz(); } }); }


    ['glow','gridOn','persistOn'].forEach(id => { var el=$(id); if(el && el.addEventListener){ el.addEventListener('input', function(){ autoSave(); try{ startViz(); }catch(e){} }); } });

    $('randSparseBtn').onclick = () => randomFill('sparse');
    $('randGrooveBtn').onclick = () => randomFill('groove');
    $('randDenseBtn').onclick = () => randomFill('dense');
    $('clearBtn').onclick = clearSeq;

    $('pagePrev').onclick = function(){ page=0; rebuildSequencerUI(); autoSave(); };
    $('pageNext').onclick = function(){ page=0; rebuildSequencerUI(); autoSave(); };

    ['touchstart','pointerdown'].forEach(function(evt){
      window.addEventListener(evt, function(){
        if (ctx && ctx.state!=='running') { ctx.resume().catch(function(){}); }
      }, {passive:true});
    });

    hookPairs();
    // Sovereign handlers
    var gvol=$('globalVol'), gdrv=$('globalDrive'), rwt=$('revWetTop'), ttop=$('tempoTop');
    if (gvol){ gvol.addEventListener('input', function(){ try{ if (globalMaster) globalMaster.gain.setTargetAtTime(+gvol.value, ctx.currentTime||0, 0.02); }catch(e){} autoSave(); }); }
    if (gdrv){ gdrv.addEventListener('input', function(){ try{ setGlobalDrive(+gdrv.value); }catch(e){} autoSave(); }); }
    if (rwt){ rwt.addEventListener('input', function(){ try{ $('revWet').value = rwt.value; $('revWetNum')? $('revWetNum').value = rwt.value : null; revWet && revWet.gain.setTargetAtTime(+rwt.value, ctx.currentTime||0, 0.05); }catch(e){} autoSave(); }); }
    if (ttop){ ttop.addEventListener('input', function(){ var v=+ttop.value; $('tempo').value=v; $('tempoNum').value=v; $('bpmRead').textContent=v+' BPM'; tempo=v; pushUIToEngine();
      try{ if($('globalVol')&&globalMaster) globalMaster.gain.setTargetAtTime(+$('globalVol').value||1, ctx.currentTime||0, 0.02); }catch(e){}
      try{ if($('globalDrive')) setGlobalDrive(+$('globalDrive').value||0); }catch(e){}
      try{ if($('revWetTop')) revWet.gain.setTargetAtTime(+$('revWetTop').value||+$('revWet').value||0.55, ctx.currentTime||0, 0.05); }catch(e){}
 autoSave(); }); }

    // Re-measure scopes on container resize (helps dock/undock/viewport changes)
    (function(){
      var card = document.querySelector('.card.card--scopes');
      if (!card || !('ResizeObserver' in window)) return;
      var raf = null;
      var ro = new ResizeObserver(function(){
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(function(){
          try{ startViz(); }catch(e){}
        });
      });
      ro.observe(card);
    })();

    // Vertical/horizontal layout toggle for scopes
    (function(){
      var rack = document.querySelector('.bigRack');
      var chk  = document.getElementById('vizVertical');
      if (!rack || !chk) return;

      // restore
      var mode = localStorage.getItem('scopes.layout') || 'vertical';
      if (mode === 'horizontal'){ rack.classList.add('horizontal'); chk.checked = false; }
      else { rack.classList.remove('horizontal'); chk.checked = true; }

      chk.addEventListener('change', function(){
        if (chk.checked){
          rack.classList.remove('horizontal');
          localStorage.setItem('scopes.layout','vertical');
        } else {
          rack.classList.add('horizontal');
          localStorage.setItem('scopes.layout','horizontal');
        }
        // re-measure canvases
        try { startViz(); } catch(e) {}
      });
    })();

    
    
    // Draggable/dockable scopes (docked = bottom-right anchor; undocked = free drag)
    (function(){
      var card = document.querySelector('.card.card--scopes');
      var header = card ? card.querySelector('.scopesHeader') : null;
      var btn = document.getElementById('dockToggle');
      if (!card || !header || !btn) return;

      function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }
      function viewportSize(){
        var vv = window.visualViewport;
        return vv ? { w: vv.width, h: vv.height } :
                    { w: window.innerWidth || document.documentElement.clientWidth || 0,
                      h: window.innerHeight || document.documentElement.clientHeight || 0 };
      }
      function storeState(){
        var mode = card.classList.contains('floating') ? 'floating' : 'docked';
        localStorage.setItem('scopes.mode', mode);
        if (mode==='floating'){
          localStorage.setItem('scopes.left', String(card.style.left||'20px'));
          localStorage.setItem('scopes.top',  String(card.style.top||'20px'));
        }
      }
      function restore(){
        var mode = localStorage.getItem('scopes.mode') || 'docked'; // default to docked (corner)
        if (mode==='floating'){
          card.classList.add('floating'); card.classList.remove('dockedBR');
          var l = localStorage.getItem('scopes.left') || '20px';
          var t = localStorage.getItem('scopes.top')  || '20px';
          card.style.left = l; card.style.top = t; card.style.right=''; card.style.bottom='';
          btn.textContent = 'Dock to corner';
        } else {
          card.classList.add('dockedBR'); card.classList.remove('floating');
          card.style.left=''; card.style.top=''; card.style.right='20px'; card.style.bottom='20px';
          btn.textContent = 'Undock';
        }
      }
      restore();

      btn.addEventListener('click', function(e){
        e.stopPropagation();
        if (card.classList.contains('floating')){
          // Go docked at bottom-right
          card.classList.remove('floating'); card.classList.add('dockedBR');
          card.style.left=''; card.style.top=''; card.style.right='20px'; card.style.bottom='20px';
          btn.textContent = 'Undock';
        } else {
          // Undock for free move
          card.classList.remove('dockedBR'); card.classList.add('floating');
          var r = card.getBoundingClientRect();
          var l = Math.max(10, r.left), t = Math.max(80, r.top);
          card.style.left = l + 'px'; card.style.top = t + 'px'; card.style.right=''; card.style.bottom='';
          btn.textContent = 'Dock to corner';
        }
        storeState();
        try{ startViz(); }catch(e){}
      });

      var dragging = false, startX=0, startY=0, baseL=0, baseT=0;
      header.addEventListener('pointerdown', function(e){
        if (!card.classList.contains('floating')) return;
        var tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'button' || tag === 'select' || tag === 'label') return;
        dragging = true;
        startX = e.clientX; startY = e.clientY;
        baseL = parseFloat(card.style.left || '20'); baseT = parseFloat(card.style.top || '20');
        try{ card.setPointerCapture(e.pointerId); }catch(_){}
        e.preventDefault();
      });
      header.addEventListener('pointermove', function(e){
        if (!dragging) return;
        var dx = e.clientX - startX, dy = e.clientY - startY;
        var vp = viewportSize();
        var cw = card.offsetWidth || 200, ch = card.offsetHeight || 200;
        var maxL = Math.max(0, vp.w - 60);
        var maxT = Math.max(0, vp.h - 60);
        var newL = clamp(baseL + dx, - (cw*0.4), maxL);
        var newT = clamp(baseT + dy, - 10, maxT);
        card.style.left = newL + 'px';
        card.style.top  = newT + 'px';
      });
      function endDrag(e){
        if (!dragging) return;
        dragging = false;
        try{ card.releasePointerCapture(e.pointerId); }catch(_){}
        storeState();
      }
      header.addEventListener('pointerup', endDrag);
      header.addEventListener('pointercancel', endDrag);

      window.addEventListener('resize', function(){
        if (card.classList.contains('dockedBR')){
          // stay anchored to corner automatically
          card.style.right = '20px'; card.style.bottom = '20px';
        } else if (card.classList.contains('floating')){
          var vp = viewportSize();
          var l = parseFloat(card.style.left||'20'); var t = parseFloat(card.style.top||'20');
          var cw = card.offsetWidth || 200, ch = card.offsetHeight || 200;
          var maxL = Math.max(0, vp.w - 60), maxT = Math.max(0, vp.h - 60);
          card.style.left = clamp(l, - (cw*0.4), maxL) + 'px';
          card.style.top  = clamp(t, - 10, maxT) + 'px';
        }
      });
    })();

  }

  async function initMIDI(){
    var status = $('midiStatus');
    if (!navigator.requestMIDIAccess){ status.textContent = "MIDI: not supported in this browser."; return; }
    try {
      var access = await navigator.requestMIDIAccess({ sysex:false });
      access.onstatechange = refreshMidiInputs; window.__midiAccess = access;
      refreshMidiInputs(); status.textContent="MIDI: ready.";
    } catch(e){ status.textContent="MIDI: access denied."; }
  }
  function refreshMidiInputs(){
    var sel=$('midiIn'); sel.innerHTML="";
    var inputs = window.__midiAccess ? Array.from(window.__midiAccess.inputs.values()) : [];
    if (inputs.length===0){ var o=document.createElement('option'); o.textContent="No inputs"; sel.appendChild(o); return; }
    inputs.forEach(function(inp, idx){ var o=document.createElement('option'); o.value=inp.id; o.textContent=inp.name||('Input '+(idx+1)); sel.appendChild(o); });
    sel.value = inputs[0].id; bindSelectedMidi(); sel.onchange = bindSelectedMidi;
  }
  function bindSelectedMidi(){
    if (!window.__midiAccess) return;
    Array.from(window.__midiAccess.inputs.values()).forEach(function(inp){ inp.onmidimessage = null; });
    var chosen = Array.from(window.__midiAccess.inputs.values()).find(function(i){ return i.id === $('midiIn').value; });
    if (chosen) { chosen.onmidimessage = handleMidi; $('midiStatus').textContent = 'MIDI: listening on "'+(chosen.name||'Input')+'"'; }
  }
  var heldNotes = new Set(), sustainOn=false;
  function handleMidi(e){
    var status = e.data[0], d1 = e.data[1], d2 = e.data[2]; var cmd = status & 0xF0;
    if (cmd===0x90 && d2>0){ heldNotes.add(d1); chooseNote(); if (!$('holdToggle').checked) envGateOn(); }
    else if (cmd===0x80 || (cmd===0x90 && d2===0)){ heldNotes.delete(d1); chooseNote(); if (!$('holdToggle').checked && !sustainOn && heldNotes.size===0) envGateOff(); }
    else if (cmd===0xB0){ if (d1===64){ sustainOn=d2>=64; if (!sustainOn && !$('holdToggle').checked && heldNotes.size===0) envGateOff(); } }
  }
  function chooseNote(){
    if (heldNotes.size===0) return;
    var mode = $('noteMode').value;
    var arr = Array.from(heldNotes.values()).sort((a,b)=>a-b);
    var note = arr[arr.length-1]; if (mode==='low') note=arr[0]; if (mode==='high') note=arr[arr.length-1];
    setBaseFrequencyFromMidi(note);
  }

  function populateOnLoad(){
    populateNotes(); buildPresets(); buildDrumPresets(); rebuildSequencerUI(); hookUI(); initMIDI();
    $('wave').value = 'triangle'; $('octave').value = 2;
    applyDrumPreset('heartbeat');
    // try to load saved state
    var __loaded = loadState();
    if (!__loaded) { try { applyPreset('cathedral-drift'); $('octave').value = 2; } catch(e){} }

  }
  window.addEventListener('load', populateOnLoad);
  function showErr(msg){ var box=$('err'); box.style.display='block'; box.textContent=msg; }
})();
</script>

<script>
(function(){
  const MIN_ANGLE = -135, MAX_ANGLE = 135;
  function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }
  function valueToAngle(input){
    const min = parseFloat(input.min || "0");
    const max = parseFloat(input.max || "1");
    const val = parseFloat(input.value || "0");
    const t = (val - min) / (max - min);
    return MIN_ANGLE + t * (MAX_ANGLE - MIN_ANGLE);
  }
  function angleToValue(input, deg){
    const min = parseFloat(input.min || "0");
    const max = parseFloat(input.max || "1");
    const step = parseFloat(input.step || "0.001");
    const t = (deg - MIN_ANGLE) / (MAX_ANGLE - MIN_ANGLE);
    let v = min + t * (max - min);
    if (!isNaN(step) && step > 0){ v = Math.round(v/step) * step; }
    return clamp(v, min, max);
  }
  function knobFor(input, labelText){
    const knob = document.createElement('div');
    knob.className = 'knob';
    knob.setAttribute('role','slider');
    knob.setAttribute('aria-valuemin', input.min||'0');
    knob.setAttribute('aria-valuemax', input.max||'1');
    knob.setAttribute('aria-valuenow', input.value||'0');
    knob.setAttribute('aria-label', labelText || input.id || 'knob');
    const face = document.createElement('div');
face.className = 'knob-face';
// illustrated layers
const ink = document.createElement('div'); ink.className = 'knob-ink';
const ring = document.createElement('div'); ring.className = 'knob-ring';
const pointer = document.createElement('div'); pointer.className = 'knob-pointer';
const tick = document.createElement('div'); tick.className = 'knob-tick';
pointer.appendChild(tick);
face.appendChild(ink);
face.appendChild(ring);
face.appendChild(pointer);
knob.appendChild(face);
    function updateFromInput(){
      const deg = valueToAngle(input);
      pointer.style.transform = `rotate(${deg}deg)`;
      knob.setAttribute('aria-valuenow', input.value);
    }
    updateFromInput();
    let dragging = false;
    function onPointerDown(e){ dragging = true; knob.setPointerCapture && knob.setPointerCapture(e.pointerId||0); e.preventDefault(); }
    function onPointerUp(e){ dragging = false; knob.releasePointerCapture && knob.releasePointerCapture(e.pointerId||0); }
    function onPointerMove(e){
      if (!dragging) return;
      const rect = knob.getBoundingClientRect();
      const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
      const dx = e.clientX - cx, dy = e.clientY - cy;
      let deg = Math.atan2(dy, dx) * 180/Math.PI + 90;
      if (deg > 180) deg -= 360;
      deg = Math.max(-135, Math.min(135, deg));
      const newVal = angleToValue(input, deg);
      if (newVal !== parseFloat(input.value)){
        input.value = String(newVal);
        input.dispatchEvent(new Event('input', {bubbles:true}));
        input.dispatchEvent(new Event('change', {bubbles:true}));
        pointer.style.transform = `rotate(${deg}deg)`;
        knob.setAttribute('aria-valuenow', input.value);
      }
      e.preventDefault();
    }
    knob.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
    input.addEventListener('input', updateFromInput);
    return knob;
  }
  function attachKnob(inputId){
    const input = document.getElementById(inputId);
    if (!input) return;
    input.classList.add('input-hidden-for-knob');
    let labelText = '';
    try{
      const row = input.closest('.row') || input.parentElement;
      const lbl = row && row.querySelector('label');
      labelText = lbl ? (lbl.textContent||'').trim() : inputId;
    }catch(e){ labelText = inputId; }
    const knob = knobFor(input, labelText);
    input.parentNode.insertBefore(knob, input.nextSibling);
  }
  window.addEventListener('DOMContentLoaded', function(){
    attachKnob('globalVol');
    attachKnob('globalDrive');
    attachKnob('revWetTop');
  }, {once:true});
})();
</script>


<script>
(function(){
  const MIN_ANGLE = -135, MAX_ANGLE = 135;
  function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }

  function addMarks(face){
    if (!face || face.querySelector('.knob-mark')) return; // already added
    const R = 26; // radial distance for marks
    // majors every 45°, minors every 15°
    for (let deg = MIN_ANGLE; deg <= MAX_ANGLE + 0.1; deg += 15){
      const isMajor = (Math.abs((deg - MIN_ANGLE) % 45) < 1e-6) || Math.abs(deg) < 1e-6;
      const mark = document.createElement('div');
      mark.className = 'knob-mark ' + (isMajor ? 'knob-mark--major' : 'knob-mark--minor');
      mark.style.transform = `rotate(${deg}deg) translateY(-${R}px)`;
      face.appendChild(mark);
    }
  }

  function ensureKnobEnhancements(inputId){
    const input = document.getElementById(inputId);
    if (!input) return;
    const parent = input.parentNode;
    const knob = parent && parent.querySelector('.knob');
    const face = knob && knob.querySelector('.knob-face');
    if (!knob || !face) return;

    // Add marks
    addMarks(face);

    // Wrap knob + readout together
    // If already wrapped, skip
    if (!knob.parentElement.classList.contains('knob-wrap')){
      const wrap = document.createElement('div');
      wrap.className = 'knob-wrap';
      parent.insertBefore(wrap, knob);
      wrap.appendChild(knob);
      // Numeric readout
      const num = document.createElement('input');
      num.type = 'number';
      num.className = 'knob-readout';
      num.min = input.min || "0";
      num.max = input.max || "1";
      num.step = input.step || "0.001";
      num.value = input.value || "0";
      // Sync number -> slider
      num.addEventListener('input', function(){
        let v = parseFloat(num.value);
        const min = parseFloat(num.min), max = parseFloat(num.max);
        if (isNaN(v)) return;
        v = clamp(v, min, max);
        if (String(v) !== input.value){
          input.value = String(v);
          input.dispatchEvent(new Event('input', {bubbles:true}));
          input.dispatchEvent(new Event('change', {bubbles:true}));
        }
      });
      // Sync slider -> number
      input.addEventListener('input', function(){
        if (num.value !== String(input.value)){
          num.value = String(input.value);
        }
      });
      wrap.appendChild(num);
    }
  }

  window.addEventListener('DOMContentLoaded', function(){
    ['globalVol','globalDrive','revWetTop'].forEach(ensureKnobEnhancements);
  }, {once:true});
})();
</script>


<script>
(function(){
  function markSovereignRow(inputId){
    var el = document.getElementById(inputId);
    if (!el) return;
    var row = el.closest('.row') || el.parentElement;
    if (row) row.classList.add('sovereign-row');
  }
  function addRimAndCap(knob){
    if (!knob || knob.querySelector('.knob-rim')) return;
    var rim = document.createElement('div'); rim.className = 'knob-rim';
    var face = knob.querySelector('.knob-face');
    knob.insertBefore(rim, face || knob.firstChild);
    if (face && !face.querySelector('.knob-cap')){
      var cap = document.createElement('div'); cap.className = 'knob-cap';
      face.appendChild(cap);
    }
  }
  window.addEventListener('DOMContentLoaded', function(){
    ['globalVol','globalDrive','revWetTop'].forEach(function(id){
      markSovereignRow(id);
      var input = document.getElementById(id);
      var knob = input && input.parentElement && input.parentElement.querySelector('.knob');
      if (knob) addRimAndCap(knob);
    });
  }, {once:true});
})();
</script>


<script>
(function(){
  function markSovereignRow(inputId){
    var el = document.getElementById(inputId);
    if (!el) return;
    var row = el.closest('.row') || el.parentElement;
    if (row) row.classList.add('sovereign-row');
  }
  window.addEventListener('DOMContentLoaded', function(){
    ['globalVol','globalDrive','revWetTop'].forEach(markSovereignRow);
  }, {once:true});
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  ['tempoTop','tempo'].forEach(function(id){
    var el = document.getElementById(id);
    if (!el) return;
    var row = el.closest('.row') || el.parentElement;
    if (row) row.classList.add('wide-slider-row');
  });
}, {once:true});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var drumsDetails = Array.from(document.querySelectorAll('details.card')).find(function(d){
      var t = d.querySelector('summary span'); return t && /Drums/i.test(t.textContent||'');
    });
    if (!drumsDetails) return;
    var showingEl = Array.from(drumsDetails.querySelectorAll('span,div')).find(function(n){
      return /showing\s*\d+\s*-\s*\d+/i.test((n.textContent||''));
    });
    if (!showingEl) return;
    var gridCandidate = Array.from(drumsDetails.querySelectorAll('.gridAuto, .grid2, .row, .seq, .steps, .drum-grid')).find(function(el){
      var btns = el.querySelectorAll('button'); return btns && btns.length >= 8;
    });
    if (!gridCandidate) return;
    var wrapper = document.createElement('div');
    wrapper.style.margin = '0 0 8px 0';
    wrapper.style.fontSize = '12px';
    wrapper.style.color = 'var(--text, #0F1108)';
    wrapper.appendChild(document.createTextNode(showingEl.textContent || ''));
    gridCandidate.parentNode.insertBefore(wrapper, gridCandidate);
    showingEl.style.display = 'none';
  }catch(e){ console.warn('Could not reposition showing indicator', e); }
}, {once:true});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    var drums = Array.from(document.querySelectorAll('details.card')).find(function(d){
      var t = d.querySelector('summary span'); return t && /^(\s*)Drums(\s*)$/.test(t.textContent||'');
    });
    if (!drums) return;
    drums.classList.add('drums');
    var label = drums.querySelector('#pageLabel');
    var seqHead = drums.querySelector('#seqHead');
    if (label && seqHead && label.parentNode !== seqHead.parentNode){
      // create a wrapper above seqHead and move the label there
      var wrap = document.createElement('div');
      wrap.className = 'seq-page-label';
      wrap.style.margin = '0 0 6px 0';
      seqHead.parentNode.insertBefore(wrap, seqHead);
      wrap.appendChild(label);
      label.style.display = ''; // ensure visible
    }
  } catch (e) { console.warn('Drums patch failed', e); }
}, {once:true});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var drums = Array.from(document.querySelectorAll('details.card')).find(function(d){
      var t = d.querySelector('summary span'); return t && /^(\s*)Drums(\s*)$/.test(t.textContent||'');
    });
    if (!drums) return;
    drums.classList.add('drums');
    var label = drums.querySelector('#pageLabel');
    var seqHead = drums.querySelector('#seqHead');
    if (label && seqHead && label.parentNode !== seqHead.parentNode){
      var wrap = document.createElement('div');
      wrap.className = 'seq-page-label';
      wrap.style.margin = '0 0 6px 0';
      seqHead.parentNode.insertBefore(wrap, seqHead);
      wrap.appendChild(label);
      label.style.display = '';
    }
  }catch(e){}
}, {once:true});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    var header = document.querySelector('.card--scopes .scopesHeader');
    if (header){
      Array.from(header.querySelectorAll('label')).forEach(function(l){
        var t = (l.textContent||'').trim().toLowerCase();
        if (t.startsWith('vertical layout')) l.style.display = 'none';
      });
    }
  } catch(e){}
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var header = document.querySelector('.card--scopes .scopesHeader');
    if(header){
      Array.from(header.querySelectorAll('button')).forEach(function(b){
        if((b.textContent||'').trim().toLowerCase()==='undock'){ b.style.display='none'; }
      });
      // also hide any 'Scopes' text node inside <strong> or plain nodes
      var s = header.querySelector('strong');
      if(s && (s.textContent||'').trim().toLowerCase()==='scopes'){ s.style.display='none'; }
    }
  }catch(e){}
});
</script>
</body>
</html>
